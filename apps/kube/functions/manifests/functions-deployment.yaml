apiVersion: apps/v1
kind: Deployment
metadata:
    name: functions
    namespace: kilobase
spec:
    replicas: 1
    selector:
        matchLabels:
            app: functions
    template:
        metadata:
            labels:
                app: functions
            annotations:
                rollout-restart: '2026-02-28T00:00:00Z'
        spec:
            containers:
                - name: edge-functions
                  image: ghcr.io/kbve/edge:latest
                  imagePullPolicy: Always
                  command:
                      - 'edge-runtime'
                      - 'start'
                      - '--main-service'
                      - '/home/deno/functions/main'
                  env:
                      - name: JWT_SECRET
                        valueFrom:
                            secretKeyRef:
                                name: supabase-shared
                                key: jwt-secret
                      - name: SUPABASE_URL
                        value: 'http://kong:8000'
                      - name: SUPABASE_ANON_KEY
                        valueFrom:
                            secretKeyRef:
                                name: supabase-shared
                                key: anon-key
                      - name: SUPABASE_SERVICE_ROLE_KEY
                        valueFrom:
                            secretKeyRef:
                                name: supabase-shared
                                key: service-role-key
                      - name: SUPABASE_DB_URL
                        valueFrom:
                            secretKeyRef:
                                name: supabase-shared
                                key: db-url
                      - name: HCAPTCHA_SECRET
                        valueFrom:
                            secretKeyRef:
                                name: hcaptcha-config
                                key: secret-key
                      - name: VERIFY_JWT
                        value: 'true'
                  resources:
                      requests:
                          memory: '256Mi'
                          cpu: '100m'
                      limits:
                          memory: '512Mi'
                          cpu: '500m'
