<svg xmlns="http://www.w3.org/2000/svg" width="400" height="400" viewBox="0 0 400 400">
  <defs>
    <linearGradient id="map-bg" x1="0" y1="0" x2="0" y2="1">
      <stop offset="0%" stop-color="#1a1a2e"/>
      <stop offset="100%" stop-color="#0f0f1a"/>
    </linearGradient>
  </defs>

  <!-- Background -->
  <rect width="400" height="400" fill="url(#map-bg)" rx="12"/>

  <!-- Header -->
  <rect x="0" y="0" width="400" height="36" fill="#2a2a4a" rx="12"/>
  <rect x="0" y="18" width="400" height="18" fill="#2a2a4a"/>
  <text x="200" y="25" text-anchor="middle" font-family="Alagard, sans-serif" font-size="14" fill="#e0e0e0" font-weight="bold">Dungeon Map ({{ player_x }}, {{ player_y }})</text>

  <!-- Grid: 7x7, each cell 48x48 with 4px spacing = 52px pitch -->
  <!-- Total grid: 7*52 - 4 = 360px wide, offset x=20 y=44 to center -->

  {% for tile in tiles %}
  {% if tile.is_discovered || tile.is_visited %}

  <!-- Tile background -->
  <rect x="{{ tile.tx }}" y="{{ tile.ty }}" width="48" height="48" rx="6"
    fill="{{ tile.fill_color }}"
    {% if !tile.is_visited %}opacity="0.35"{% else %}opacity="0.8"{% endif %}/>

  {% if tile.is_current %}
  <!-- Current position highlight -->
  <rect x="{{ tile.tx - 2 }}" y="{{ tile.ty - 2 }}" width="52" height="52" rx="8"
    fill="none" stroke="#ffd700" stroke-width="2.5"/>
  {% endif %}

  <!-- Room type SVG icon (font-independent) -->
  {% if tile.icon_id == "combat" %}
  <!-- Crossed swords -->
  <line x1="{{ tile.cx - 5 }}" y1="{{ tile.cy - 5 }}" x2="{{ tile.cx + 5 }}" y2="{{ tile.cy + 5 }}" stroke="{{ tile.icon_color }}" stroke-width="2" stroke-linecap="round"/>
  <line x1="{{ tile.cx + 5 }}" y1="{{ tile.cy - 5 }}" x2="{{ tile.cx - 5 }}" y2="{{ tile.cy + 5 }}" stroke="{{ tile.icon_color }}" stroke-width="2" stroke-linecap="round"/>
  {% endif %}

  {% if tile.icon_id == "boss" %}
  <!-- Skull -->
  <circle cx="{{ tile.cx }}" cy="{{ tile.cy - 1 }}" r="6" fill="none" stroke="{{ tile.icon_color }}" stroke-width="1.5"/>
  <circle cx="{{ tile.cx - 2 }}" cy="{{ tile.cy - 2 }}" r="1.2" fill="{{ tile.icon_color }}"/>
  <circle cx="{{ tile.cx + 2 }}" cy="{{ tile.cy - 2 }}" r="1.2" fill="{{ tile.icon_color }}"/>
  <line x1="{{ tile.cx - 3 }}" y1="{{ tile.cy + 4 }}" x2="{{ tile.cx + 3 }}" y2="{{ tile.cy + 4 }}" stroke="{{ tile.icon_color }}" stroke-width="1.5" stroke-linecap="round"/>
  {% endif %}

  {% if tile.icon_id == "treasure" %}
  <!-- Diamond -->
  <polygon points="{{ tile.cx }},{{ tile.cy - 7 }} {{ tile.cx + 6 }},{{ tile.cy }} {{ tile.cx }},{{ tile.cy + 7 }} {{ tile.cx - 6 }},{{ tile.cy }}" fill="none" stroke="{{ tile.icon_color }}" stroke-width="1.5" stroke-linejoin="round"/>
  {% endif %}

  {% if tile.icon_id == "rest" %}
  <!-- Plus/cross (healing) -->
  <line x1="{{ tile.cx }}" y1="{{ tile.cy - 6 }}" x2="{{ tile.cx }}" y2="{{ tile.cy + 6 }}" stroke="{{ tile.icon_color }}" stroke-width="2.5" stroke-linecap="round"/>
  <line x1="{{ tile.cx - 6 }}" y1="{{ tile.cy }}" x2="{{ tile.cx + 6 }}" y2="{{ tile.cy }}" stroke="{{ tile.icon_color }}" stroke-width="2.5" stroke-linecap="round"/>
  {% endif %}

  {% if tile.icon_id == "merchant" %}
  <!-- Coin with line -->
  <circle cx="{{ tile.cx }}" cy="{{ tile.cy }}" r="6" fill="none" stroke="{{ tile.icon_color }}" stroke-width="1.5"/>
  <line x1="{{ tile.cx }}" y1="{{ tile.cy - 3 }}" x2="{{ tile.cx }}" y2="{{ tile.cy + 3 }}" stroke="{{ tile.icon_color }}" stroke-width="1.5" stroke-linecap="round"/>
  <line x1="{{ tile.cx - 2 }}" y1="{{ tile.cy - 2 }}" x2="{{ tile.cx + 2 }}" y2="{{ tile.cy - 2 }}" stroke="{{ tile.icon_color }}" stroke-width="1" stroke-linecap="round"/>
  <line x1="{{ tile.cx - 2 }}" y1="{{ tile.cy + 2 }}" x2="{{ tile.cx + 2 }}" y2="{{ tile.cy + 2 }}" stroke="{{ tile.icon_color }}" stroke-width="1" stroke-linecap="round"/>
  {% endif %}

  {% if tile.icon_id == "city" %}
  <!-- House -->
  <polygon points="{{ tile.cx }},{{ tile.cy - 7 }} {{ tile.cx + 7 }},{{ tile.cy }} {{ tile.cx - 7 }},{{ tile.cy }}" fill="none" stroke="{{ tile.icon_color }}" stroke-width="1.5" stroke-linejoin="round"/>
  <rect x="{{ tile.cx - 5 }}" y="{{ tile.cy }}" width="10" height="7" fill="none" stroke="{{ tile.icon_color }}" stroke-width="1.5"/>
  {% endif %}

  {% if tile.icon_id == "story" %}
  <!-- Scroll/book -->
  <rect x="{{ tile.cx - 4 }}" y="{{ tile.cy - 6 }}" width="8" height="12" rx="1" fill="none" stroke="{{ tile.icon_color }}" stroke-width="1.5"/>
  <line x1="{{ tile.cx - 2 }}" y1="{{ tile.cy - 3 }}" x2="{{ tile.cx + 2 }}" y2="{{ tile.cy - 3 }}" stroke="{{ tile.icon_color }}" stroke-width="1"/>
  <line x1="{{ tile.cx - 2 }}" y1="{{ tile.cy }}" x2="{{ tile.cx + 2 }}" y2="{{ tile.cy }}" stroke="{{ tile.icon_color }}" stroke-width="1"/>
  <line x1="{{ tile.cx - 2 }}" y1="{{ tile.cy + 3 }}" x2="{{ tile.cx + 2 }}" y2="{{ tile.cy + 3 }}" stroke="{{ tile.icon_color }}" stroke-width="1"/>
  {% endif %}

  {% if tile.icon_id == "trap" %}
  <!-- Warning triangle -->
  <polygon points="{{ tile.cx }},{{ tile.cy - 7 }} {{ tile.cx + 7 }},{{ tile.cy + 5 }} {{ tile.cx - 7 }},{{ tile.cy + 5 }}" fill="none" stroke="{{ tile.icon_color }}" stroke-width="1.5" stroke-linejoin="round"/>
  <line x1="{{ tile.cx }}" y1="{{ tile.cy - 3 }}" x2="{{ tile.cx }}" y2="{{ tile.cy + 1 }}" stroke="{{ tile.icon_color }}" stroke-width="1.5" stroke-linecap="round"/>
  <circle cx="{{ tile.cx }}" cy="{{ tile.cy + 3 }}" r="1" fill="{{ tile.icon_color }}"/>
  {% endif %}

  {% if tile.icon_id == "hallway" %}
  <!-- Horizontal dash -->
  <line x1="{{ tile.cx - 6 }}" y1="{{ tile.cy }}" x2="{{ tile.cx + 6 }}" y2="{{ tile.cy }}" stroke="{{ tile.icon_color }}" stroke-width="2" stroke-linecap="round"/>
  {% endif %}

  {% if tile.icon_id == "unknown" %}
  <!-- Question mark (discovered but unvisited) -->
  <text x="{{ tile.cx }}" y="{{ tile.cy + 5 }}" text-anchor="middle" font-family="Alagard, sans-serif" font-size="14" fill="{{ tile.icon_color }}">?</text>
  {% endif %}

  {% if tile.cleared && tile.is_visited %}
  <!-- Cleared indicator (small green dot) -->
  <circle cx="{{ tile.tx + 42 }}" cy="{{ tile.ty + 6 }}" r="3" fill="#44cc44" opacity="0.9"/>
  {% endif %}

  <!-- Exit path connectors (lines between tiles) -->
  {% if tile.has_exit_n && tile.is_visited %}
  <line x1="{{ tile.cx }}" y1="{{ tile.ty }}"
        x2="{{ tile.cx }}" y2="{{ tile.ty - 4 }}"
        stroke="#667788" stroke-width="3" stroke-linecap="round"/>
  {% endif %}
  {% if tile.has_exit_s && tile.is_visited %}
  <line x1="{{ tile.cx }}" y1="{{ tile.ty + 48 }}"
        x2="{{ tile.cx }}" y2="{{ tile.ty + 52 }}"
        stroke="#667788" stroke-width="3" stroke-linecap="round"/>
  {% endif %}
  {% if tile.has_exit_e && tile.is_visited %}
  <line x1="{{ tile.tx + 48 }}" y1="{{ tile.cy }}"
        x2="{{ tile.tx + 52 }}" y2="{{ tile.cy }}"
        stroke="#667788" stroke-width="3" stroke-linecap="round"/>
  {% endif %}
  {% if tile.has_exit_w && tile.is_visited %}
  <line x1="{{ tile.tx }}" y1="{{ tile.cy }}"
        x2="{{ tile.tx - 4 }}" y2="{{ tile.cy }}"
        stroke="#667788" stroke-width="3" stroke-linecap="round"/>
  {% endif %}

  {% endif %}
  {% endfor %}

  <!-- Footer -->
  <text x="20" y="392" font-family="Alagard, sans-serif" font-size="10" fill="#667788">Tiles: {{ tiles_explored }}</text>
  <text x="380" y="392" text-anchor="end" font-family="Alagard, sans-serif" font-size="10" fill="#667788">Depth: {{ depth }}</text>
</svg>
