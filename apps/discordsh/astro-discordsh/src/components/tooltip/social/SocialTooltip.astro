---
interface Props {
	id?: string;
	title?: string;
	description?: string;
	badge?: string;
	meta?: string;
	direction?: 'auto' | 'top' | 'bottom';
	align?: 'center' | 'start' | 'end';
	size?: 'sm' | 'md' | 'lg';
	disabled?: boolean;
	ringColor?: string;
}

const {
	id = `stt-${Math.random().toString(36).slice(2)}`,
	title = 'Important Information',
	description = 'This is a tooltip with detailed information and custom styling.',
	badge = 'Premium Feature',
	meta = '',
	direction = 'auto',
	align = 'center',
	size = 'md',
	disabled = false,
	ringColor = '#1877f2',
} = Astro.props;
---

<div
	class:list={[
		'stt not-content',
		`stt--${size}`,
		`stt--align-${align}`,
		`stt--dir-${direction === 'auto' ? 'bottom' : direction}`,
		disabled && 'stt--disabled',
	]}
	style={`--stt-ring: ${ringColor};`}
	id={id}
	data-stt-root
	data-stt-dir={direction}>
	<!-- Trigger -->
	<button
		type="button"
		class="stt__trigger relative inline-flex items-center justify-center gap-2.5 border-none bg-transparent cursor-pointer p-0 outline-none"
		aria-haspopup="dialog"
		aria-expanded="false"
		disabled={disabled}
		data-stt-trigger>
		<span
			class="stt__layer relative w-14 h-14 rounded-full grid place-items-center"
			aria-hidden="true">
			<span></span><span></span><span></span><span></span><span></span>
		</span>

		<span
			class="stt__icon absolute inset-0 grid place-items-center w-14 h-14 rounded-full text-white"
			aria-hidden="true">
			<slot name="icon">
				<svg
					viewBox="0 0 24 24"
					width="20"
					height="20"
					fill="none"
					stroke="currentColor">
					<path
						d="M12 8h.01M11 12h1v4h1"
						stroke-width="2"
						stroke-linecap="round">
					</path>
					<path
						d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
						stroke-width="2">
					</path>
				</svg>
			</slot>
		</span>

		<span
			class="stt__text absolute left-1/2 -bottom-1.5 -translate-x-1/2 font-semibold text-xs opacity-0 pointer-events-none whitespace-nowrap transition-all duration-300">
			<slot name="label">Hover</slot>
		</span>
	</button>

	<!-- Panel (hidden by default, script toggles .stt--open) -->
	<div
		class="stt__panel absolute left-1/2 pointer-events-none opacity-0 invisible z-50"
		role="tooltip"
		data-stt-panel>
		<slot name="content">
			<div
				class="stt__card relative rounded-2xl border border-white/10 backdrop-blur-md overflow-hidden">
				<div
					class="stt__cardGlow absolute pointer-events-none"
					aria-hidden="true">
				</div>

				<div class="relative flex gap-2.5 items-center mb-2">
					<div
						class="stt__badgeIcon w-8 h-8 rounded-full grid place-items-center flex-none">
						<svg
							viewBox="0 0 20 20"
							fill="currentColor"
							width="16"
							height="16">
							<path
								fill-rule="evenodd"
								clip-rule="evenodd"
								d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z">
							</path>
						</svg>
					</div>
					<h3
						class="relative m-0 text-sm font-bold text-white/90 leading-tight">
						{title}
					</h3>
				</div>

				<div class="relative">
					<p class="m-0 mb-2.5 text-sm leading-snug text-gray-300/90">
						{description}
					</p>
					<div class="flex items-center justify-between gap-2.5">
						<div
							class="inline-flex items-center gap-1.5 text-xs text-gray-400 px-2 py-1.5 rounded-full bg-white/5 border border-white/10 whitespace-nowrap">
							<svg
								viewBox="0 0 20 20"
								fill="currentColor"
								width="14"
								height="14"
								aria-hidden="true">
								<path
									fill-rule="evenodd"
									clip-rule="evenodd"
									d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z">
								</path>
							</svg>
							<span>{badge}</span>
						</div>
						{
							meta && (
								<span class="text-xs text-gray-400/90 whitespace-nowrap">
									{meta}
								</span>
							)
						}
					</div>
				</div>

				<div
					class="stt__arrow absolute left-1/2 w-3 h-3 -translate-x-1/2 rotate-45"
					aria-hidden="true">
				</div>
			</div>
		</slot>
	</div>
</div>

<!-- Vanilla subscriber to nanostores event engine (no React needed) -->
<script>
	import { $activeTooltip, openTooltip, closeTooltip } from '@kbve/droid';
	import { resolveDirection, prefersReducedMotion } from './sttService';

	document
		.querySelectorAll<HTMLElement>('[data-stt-root]')
		.forEach((root) => {
			const id = root.id;
			const trigger =
				root.querySelector<HTMLElement>('[data-stt-trigger]');
			const panel = root.querySelector<HTMLElement>('[data-stt-panel]');
			if (!trigger || !panel) return;

			const dir = root.dataset.sttDir || 'auto';
			const reduced = prefersReducedMotion();

			const open = () => openTooltip(id);
			const close = () => closeTooltip(id);

			root.addEventListener('pointerenter', open);
			root.addEventListener('pointerleave', close);
			trigger.addEventListener('focus', open);
			trigger.addEventListener('blur', close);

			$activeTooltip.subscribe((activeId) => {
				const isOpen = activeId === id;

				if (isOpen) {
					if (reduced) root.classList.add('stt--reduce');
					root.classList.add('stt--open');
					trigger.setAttribute('aria-expanded', 'true');

					if (dir === 'auto') {
						const resolved = resolveDirection(root, panel, 'auto');
						root.classList.toggle(
							'stt--dir-top',
							resolved === 'top',
						);
						root.classList.toggle(
							'stt--dir-bottom',
							resolved === 'bottom',
						);
					}
				} else {
					root.classList.remove('stt--open');
					trigger.setAttribute('aria-expanded', 'false');
				}
			});
		});
</script>

<style>
	/* Root */
	.stt {
		position: relative;
		display: inline-flex;
		align-items: center;
		justify-content: center;
		--stt-ring: #1877f2;
		--stt-bg0: rgba(17, 24, 39, 0.92);
		--stt-bg1: rgba(31, 41, 55, 0.92);
		--stt-border: rgba(255, 255, 255, 0.1);
		--stt-gap: 10px;
		--stt-y: 14px;
		--stt-x: 0px;
	}

	.stt--disabled {
		opacity: 0.5;
		pointer-events: none;
	}
	.stt--sm .stt__panel {
		width: 16rem;
	}
	.stt--md .stt__panel {
		width: 18rem;
	}
	.stt--lg .stt__panel {
		width: 22rem;
	}

	.stt--align-center {
		--stt-x: 0px;
	}
	.stt--align-start {
		--stt-x: -35%;
	}
	.stt--align-end {
		--stt-x: 35%;
	}

	/* Trigger ring */
	.stt__layer {
		border: 3px solid var(--stt-ring);
		box-shadow:
			0 0 15px color-mix(in oklab, var(--stt-ring) 70%, transparent),
			0 0 22px color-mix(in oklab, var(--stt-ring) 45%, transparent);
		transition:
			transform 280ms ease,
			box-shadow 280ms ease;
	}

	.stt__layer > span {
		position: absolute;
		inset: 0;
		border-radius: inherit;
		border: 1px solid color-mix(in oklab, var(--stt-ring) 95%, white 5%);
		opacity: 0;
		transform: translate(0, 0);
		transition:
			transform 280ms ease,
			opacity 280ms ease,
			box-shadow 280ms ease;
	}

	.stt__icon {
		background: linear-gradient(
			45deg,
			color-mix(in oklab, var(--stt-ring) 95%, #3b5998 5%) 0%,
			#3b5998 30%,
			var(--stt-ring) 60%,
			#3b5998 100%
		);
		box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
		transition:
			transform 280ms ease,
			box-shadow 280ms ease,
			width 280ms ease,
			height 280ms ease;
	}

	.stt--open .stt__icon {
		width: 36px;
		height: 36px;
		transform: translate(20px, -20px) skew(12deg);
		box-shadow:
			inset 0 0 0 1px rgba(255, 255, 255, 0.15),
			0 0 18px color-mix(in oklab, var(--stt-ring) 80%, transparent);
	}

	/* Hover / open: twist + layer spread */
	.stt--open .stt__layer {
		transform: rotate(-28deg) skew(18deg);
		box-shadow:
			0 0 26px color-mix(in oklab, var(--stt-ring) 85%, transparent),
			0 0 42px color-mix(in oklab, var(--stt-ring) 55%, transparent);
	}

	.stt--open .stt__layer > span {
		opacity: 1;
		box-shadow: -1px 1px 3px
			color-mix(in oklab, var(--stt-ring) 90%, transparent);
	}
	.stt--open .stt__layer > span:nth-child(1) {
		opacity: 0.18;
		transform: scale(0.5);
	}
	.stt--open .stt__layer > span:nth-child(2) {
		opacity: 0.34;
		transform: translate(5px, -5px) scale(0.58);
	}
	.stt--open .stt__layer > span:nth-child(3) {
		opacity: 0.52;
		transform: translate(10px, -10px) scale(0.66);
	}
	.stt--open .stt__layer > span:nth-child(4) {
		opacity: 0.7;
		transform: translate(15px, -15px) scale(0.78);
	}
	.stt--open .stt__layer > span:nth-child(5) {
		opacity: 0.88;
		transform: translate(20px, -20px) scale(0.9);
	}

	.stt--open .stt__text {
		opacity: 1;
		transform: translateX(-50%) translateY(8px);
	}

	/* Panel positioning + open animation */
	.stt__panel {
		transition:
			opacity 220ms ease,
			transform 220ms ease,
			visibility 0ms linear 220ms;
	}

	.stt--dir-bottom .stt__panel,
	.stt--dir-auto .stt__panel {
		top: calc(100% + var(--stt-y));
		transform: translateX(-50%) translateX(var(--stt-x)) translateY(6px);
	}

	.stt--dir-top .stt__panel {
		bottom: calc(100% + var(--stt-y));
		top: auto;
		transform: translateX(-50%) translateX(var(--stt-x)) translateY(-6px);
	}

	.stt--open .stt__panel {
		opacity: 1;
		visibility: visible;
		pointer-events: auto;
		transition:
			opacity 220ms ease,
			transform 220ms ease,
			visibility 0ms linear 0ms;
	}

	.stt--open.stt--dir-bottom .stt__panel,
	.stt--open.stt--dir-auto .stt__panel,
	.stt--open.stt--dir-top .stt__panel {
		transform: translateX(-50%) translateX(var(--stt-x)) translateY(0);
	}

	/* Card chrome */
	.stt__card {
		padding: 14px;
		background: linear-gradient(135deg, var(--stt-bg0), var(--stt-bg1));
		box-shadow: 0 18px 50px rgba(0, 0, 0, 0.45);
	}

	.stt__cardGlow {
		inset: -30%;
		background: radial-gradient(
			circle at 30% 20%,
			rgba(79, 70, 229, 0.25),
			rgba(168, 85, 247, 0.1),
			transparent 60%
		);
		filter: blur(22px);
		opacity: 0.75;
	}

	.stt__badgeIcon {
		background: rgba(99, 102, 241, 0.18);
		color: rgba(129, 140, 248, 1);
		box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.08);
	}

	/* Arrow */
	.stt__arrow {
		background: linear-gradient(135deg, var(--stt-bg0), var(--stt-bg1));
		border-right: 1px solid var(--stt-border);
		border-bottom: 1px solid var(--stt-border);
		opacity: 0.95;
	}

	.stt--dir-bottom .stt__arrow,
	.stt--dir-auto .stt__arrow {
		top: -6px;
		border-right: none;
		border-bottom: none;
		border-left: 1px solid var(--stt-border);
		border-top: 1px solid var(--stt-border);
	}

	.stt--dir-top .stt__arrow {
		bottom: -6px;
	}

	/* Label color from ring */
	.stt__text {
		color: var(--stt-ring);
	}

	/* Reduced motion */
	.stt--reduce * {
		transition-duration: 1ms !important;
		animation-duration: 1ms !important;
	}
</style>
