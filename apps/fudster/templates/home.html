<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>WebSocket Chat with KBVECommand</title>

		<!-- Tailwind CSS v4 Browser -->
    	<script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
		
		<!-- Supabase Initialization (First Priority) -->
		<script type="module">
			// Import Supabase first
			import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
			
			// Initialize Supabase client directly with real credentials
			try {
				const supabaseUrl = 'https://qmpdruitzlownnnnjmpk.supabase.co';
				const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFtcGRydWl0emxvd25ubm5qbXBrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk2NjA0NTYsImV4cCI6MjA2NTIzNjQ1Nn0.OhD3qN4dq0TMA65qVGvry_QsZEeLKK7RbwYP3QzAvcY';
				
				// Create Supabase client
				window.supabase = createClient(supabaseUrl, supabaseKey);
				window.supabaseReady = true;
				console.log('✅ Supabase client initialized:', window.supabase);
			} catch (error) {
				console.error('❌ Failed to initialize Supabase:', error);
				window.supabase = null;
				window.supabaseReady = false;
			}
		</script>
		
		<!-- KBVE Droid Initialization (Second Priority) -->
		<script type="module">
			// Import KBVE Droid library with specific imports
			import { droid, modUrls, workerStrings } from 'https://esm.sh/@kbve/droid';
			
			// Import Comlink for worker communication
			import * as comlink from 'https://esm.sh/comlink';
			
			// Initialize workers with local URLs (served by FastAPI)
			let astroStrings;
			try {
				console.log('Loading workers from local FastAPI server...');
				astroStrings = {
					canvasWorker: new Worker('/assets/canvas-worker.js', { type: 'module' }),
					dbWorker: new SharedWorker('/assets/db-worker.js', { type: 'module' }),
					wsWorker: new SharedWorker('/assets/ws-worker.js', { type: 'module' }),
				};
				console.log('Workers loaded successfully:', astroStrings);
			} catch (error) {
				console.error('Failed to load workers from local server:', error);
				
				// Fallback: create minimal workers
				console.log('Falling back to minimal worker setup...');
				const minimalWorkerCode = `
					// Minimal worker fallback
					self.addEventListener('message', function(e) {
						console.log('Worker received:', e.data);
						self.postMessage({ type: 'response', data: 'Worker unavailable' });
					});
				`;
				const blob = new Blob([minimalWorkerCode], { type: 'application/javascript' });
				const blobURL = URL.createObjectURL(blob);
				
				astroStrings = {
					canvasWorker: new Worker(blobURL),
					dbWorker: new SharedWorker(blobURL),
					wsWorker: new SharedWorker(blobURL),
				};
			}
			
			// Initialize Droid with ONLY workerRefs (no workerURLs to avoid MIME issues)
			try {
				console.log("[DROID] init Library");
				// Use both local workerRefs and local workerURLs
				const localWorkerURLs = {
					canvasWorker: '/assets/canvas-worker.js',
					dbWorker: '/assets/db-worker.js',
					wsWorker: '/assets/ws-worker.js'
				};
				
				await droid({ 
					workerRefs: astroStrings,
					workerURLs: localWorkerURLs
				});
				
				// Access droid components from window.kbve (assigned internally by droid)
				const mod = window.kbve?.mod;
				const emitFromWorker = window.kbve?.uiux?.emitFromWorker;
				
				if (!mod) {
					console.error('[KBVE] Mod manager not available');
					window.droidReady = false;
				} else {
					// Load bento mod if available
					if (modUrls.bento) {
						const bentoMod = await mod.load(modUrls.bento);
						console.log('[DEBUG] Loaded mod ID:', bentoMod?.id);
						console.log('[DEBUG] Registry keys:', Object.keys(mod.registry));
						
						if (bentoMod?.instance?.init && typeof emitFromWorker === 'function') {
							await bentoMod.instance.init(comlink.proxy({ emitFromWorker }));
						}
						
						if (bentoMod?.meta) {
							console.log(`[Event] Bento Mod Firing`);
							window.kbve?.events?.emit('droid-mod-ready', {
								meta: bentoMod.meta,
								timestamp: Date.now(),
							});
						}
						
						console.log('[KBVE] Bento mod loaded');
					}
					
					window.droidReady = true;
				}
				
				console.log('Droid initialized successfully with local workers and URLs:', {
					workerRefs: astroStrings,
					workerURLs: localWorkerURLs
				});
			} catch (error) {
				console.error('Failed to initialize Droid:', error);
				window.droidReady = false;
			}
			
			// Make other libraries available globally
			window.comlink = comlink;
			window.modUrls = modUrls;
			window.workerStrings = workerStrings;
			window.astroStrings = astroStrings;
			
			// Log initialization status
			console.log('KBVE Droid library loaded:', droid);
			console.log('Comlink loaded:', comlink);
			console.log('Local worker URLs used:', {
				canvasWorker: '/assets/canvas-worker.js',
				dbWorker: '/assets/db-worker.js',
				wsWorker: '/assets/ws-worker.js'
			});
			console.log('Original workerStrings from droid package (not used):', workerStrings);
			console.log('Workers configured:', astroStrings);
		</script>
		
		<script>
			// Tailwind CSS v4 configuration with dark theme and purple colors
			// Note: This is for development only, use CLI/PostCSS in production
			if (typeof tailwind !== 'undefined') {
				tailwind.config = {
					theme: {
						extend: {
							colors: {
								primary: '#a855f7',     // purple-500
								secondary: '#c084fc',   // purple-400
								accent: '#e879f9',      // fuchsia-400
								dark: '#18181b',        // zinc-900
								'dark-lighter': '#27272a', // zinc-800
								'dark-light': '#3f3f46',   // zinc-700
							},
						},
					},
				};
			}
		</script>
	</head>
	<body class="bg-zinc-900 text-white min-h-screen">
		<!-- Navbar -->
		<nav class="bg-dark border-b border-zinc-700 p-4">
			<div class="container mx-auto flex justify-between items-center">
				<a href="#" class="text-2xl font-bold text-primary">FUDSTER</a>
				<div>
					<a
						href="https://kbve.com/projects/"
						target="_blank"
						class="ml-4 text-lg text-gray-300 hover:text-primary transition-colors">
						About
					</a>
					<a
						href="https://kbve.com/services/"
						target="_blank"
						class="ml-4 text-lg text-gray-300 hover:text-primary transition-colors">
						Services
					</a>
					<a
						href="https://kbve.com/discord/"
						target="_blank"
						class="ml-4 text-lg text-gray-300 hover:text-primary transition-colors">
						Discord
					</a>
				</div>
			</div>
		</nav>

		<!-- Runelite Control -->
		<section class="bg-dark-lighter border border-zinc-700 text-white p-6 rounded-lg mb-6 mx-4">
			<h2 class="text-3xl font-bold mb-4 text-primary">Runelite Control</h2>
			<div class="flex justify-center space-x-4">
				<button
					class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-zinc-900 transition-all"
					onclick="startRunelite()">
					Start Runelite
				</button>
				<button
					class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 focus:ring-offset-zinc-900 transition-all"
					onclick="stopRunelite()">
					Stop Runelite
				</button>
			</div>
			<div
				id="statusMessage"
				class="mt-4 text-center text-gray-300"></div>
		</section>

		<!-- Droid Integration Section -->
		<section class="bg-dark-lighter border border-zinc-700 text-white p-6 rounded-lg mb-6 mx-4">
			<h2 class="text-3xl font-bold mb-4 text-center text-primary">KBVE Droid Integration</h2>
			<div class="grid grid-cols-1 md:grid-cols-2 gap-6">
				<!-- Droid Status -->
				<div class="bg-dark-light border border-zinc-600 p-4 rounded-lg">
					<h3 class="text-xl font-semibold mb-2 text-secondary">Droid Status</h3>
					<div id="droidStatus" class="text-sm text-gray-300">Loading Droid...</div>
					<button 
						class="mt-3 px-4 py-2 bg-primary text-white rounded-lg hover:bg-purple-600 transition-all"
						onclick="testDroid()">
						Test Droid Functions
					</button>
				</div>
				
				<!-- Supabase Connection -->
				<div class="bg-dark-light border border-zinc-600 p-4 rounded-lg">
					<h3 class="text-xl font-semibold mb-2 text-secondary">Supabase Connection</h3>
					<div id="supabaseStatus" class="text-sm text-gray-300">Supabase ready for configuration</div>
					<button 
						class="mt-3 px-4 py-2 bg-accent text-white rounded-lg hover:bg-fuchsia-500 transition-all"
						onclick="testSupabase()">
						Test Supabase
					</button>
				</div>
			</div>
			
			<!-- Droid Command Interface -->
			<div class="mt-6 bg-dark-light border border-zinc-600 p-4 rounded-lg">
				<h3 class="text-xl font-semibold mb-2 text-secondary">Droid Command Interface</h3>
				<div class="flex gap-2 mb-2">
					<input 
						type="text" 
						id="droidCommand" 
						placeholder="Enter Droid command..." 
						class="flex-1 px-3 py-2 bg-zinc-800 border border-zinc-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
					/>
					<button 
						class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all"
						onclick="executeDroidCommand()">
						Execute Local
					</button>
					<button 
						class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-purple-600 transition-all"
						onclick="sendDroidCommandViaWS()">
						Send via WS
					</button>
				</div>
				<div id="droidOutput" class="bg-zinc-800 border border-zinc-600 p-3 rounded-lg text-sm font-mono max-h-32 overflow-y-auto text-gray-300"></div>
			</div>
		</section>

		<script>
			// Droid Integration Functions
			function testDroid() {
				const statusDiv = document.getElementById('droidStatus');
				try {
					if (window.kbve && window.droidReady) {
						const availableModules = Object.keys(window.kbve);
						statusDiv.innerHTML = `
							<div class="text-green-600">✓ Droid initialized successfully</div>
							<div class="text-xs mt-1">Workers loaded from local FastAPI server</div>
							<div class="text-xs mt-1">KBVE modules: ${availableModules.join(', ')}</div>
						`;
					} else if (window.kbve && window.droidReady === false) {
						statusDiv.innerHTML = `
							<div class="text-yellow-600">⚠ Droid loaded but initialization failed</div>
							<div class="text-xs mt-1">Worker loading may have failed due to CORS</div>
							<div class="text-xs mt-1">Check console for details</div>
						`;
					} else if (window.droidReady === undefined) {
						statusDiv.innerHTML = `
							<div class="text-blue-600">⏳ Droid loading...</div>
							<div class="text-xs mt-1">Loading workers from local FastAPI server</div>
							<div class="text-xs mt-1">No CORS issues with local workers</div>
						`;
					} else {
						statusDiv.innerHTML = '<div class="text-red-600">✗ Droid not available</div>';
					}
				} catch (error) {
					statusDiv.innerHTML = `<div class="text-red-600">✗ Error: ${error.message}</div>`;
				}
			}
			
			function testSupabase() {
				const statusDiv = document.getElementById('supabaseStatus');
				try {
					if (window.supabase && window.supabaseReady) {
						statusDiv.innerHTML = `
							<div class="text-green-600">✓ Supabase client initialized</div>
							<div class="text-xs mt-1">Ready for database operations</div>
						`;
					} else if (window.supabaseReady === false) {
						statusDiv.innerHTML = `
							<div class="text-red-600">✗ Supabase failed to initialize</div>
							<div class="text-xs mt-1">Check console for error details</div>
						`;
					} else {
						statusDiv.innerHTML = `
							<div class="text-yellow-600">⚠ Supabase not ready</div>
							<div class="text-xs mt-1">Still initializing...</div>
						`;
					}
				} catch (error) {
					statusDiv.innerHTML = `<div class="text-red-600">✗ Error: ${error.message}</div>`;
				}
			}
			
			function executeDroidCommand() {
				const commandInput = document.getElementById('droidCommand');
				const outputDiv = document.getElementById('droidOutput');
				const command = commandInput.value.trim();
				
				if (!command) {
					outputDiv.textContent = 'Please enter a command';
					return;
				}
				
				try {
					if (window.kbve && window.droidReady) {
						// Use the properly initialized kbve system
						outputDiv.innerHTML = `
							<div class="text-blue-600">Command: ${command}</div>
							<div class="text-gray-600">Executing via KBVE system...</div>
							<div class="text-xs text-gray-500">Timestamp: ${new Date().toISOString()}</div>
						`;
						
						// Clear the input
						commandInput.value = '';
						
						// Try to execute command through available KBVE modules
						const mod = window.kbve.mod;
						const events = window.kbve.events;
						
						if (mod && events) {
							// Emit command event through KBVE event system
							events.emit('droid-command', {
								command: command,
								timestamp: Date.now()
							});
							
							outputDiv.innerHTML += `<div class="text-green-600">Command sent to KBVE event system</div>`;
							outputDiv.innerHTML += `<div class="text-yellow-600">Available modules: ${Object.keys(window.kbve).join(', ')}</div>`;
						} else {
							outputDiv.innerHTML += `<div class="text-yellow-600">KBVE modules: ${Object.keys(window.kbve).join(', ')}</div>`;
						}
						
					} else {
						outputDiv.innerHTML = `
							<div class="text-red-600">KBVE system not ready</div>
							<div class="text-xs">Please wait for workers to initialize</div>
						`;
					}
					
				} catch (error) {
					outputDiv.innerHTML = `<div class="text-red-600">Error executing command: ${error.message}</div>`;
				}
			}
			
			// Initialize Droid integration when page loads
			document.addEventListener('DOMContentLoaded', function() {
				// Test Droid availability with longer delay to account for worker initialization
				setTimeout(testDroid, 1000);
				setTimeout(testSupabase, 1000);
				
				// Keep checking Droid status until ready
				const checkDroidStatus = setInterval(() => {
					if (window.droidReady !== undefined) {
						testDroid();
						clearInterval(checkDroidStatus);
					}
				}, 500);
				
				// Stop checking after 10 seconds
				setTimeout(() => {
					clearInterval(checkDroidStatus);
				}, 10000);
			});

			// Runelite Control Functions
			function startRunelite() {
				fetch('/ws/start-runelite', {
					method: 'GET',
				})
					.then((response) => {
						if (response.ok) {
							updateStatusMessage(
								'Runelite started successfully',
								'text-green-500',
							);
						} else {
							updateStatusMessage(
								'Failed to start Runelite',
								'text-red-500',
							);
						}
					})
					.catch((error) => {
						console.error('Error:', error);
						updateStatusMessage(
							'An error occurred while starting Runelite',
							'text-red-500',
						);
					});
			}

			function stopRunelite() {
				fetch('/ws/stop-runelite', {
					method: 'GET',
				})
					.then((response) => {
						if (response.ok) {
							updateStatusMessage(
								'Runelite stopped successfully',
								'text-green-500',
							);
						} else {
							updateStatusMessage(
								'Failed to stop Runelite',
								'text-red-500',
							);
						}
					})
					.catch((error) => {
						console.error('Error:', error);
						updateStatusMessage(
							'An error occurred while stopping Runelite',
							'text-red-500',
						);
					});
			}

			function updateStatusMessage(message, colorClass) {
				const statusDiv = document.getElementById('statusMessage');
				statusDiv.textContent = message;
				statusDiv.className = 'mt-4 text-center ' + colorClass;
			}
		</script>
		<!-- Hero Section with WebSocket Chat -->
		<section class="bg-gradient-to-br from-purple-900 via-zinc-900 to-purple-800 text-white min-h-screen flex items-center">
			<div class="container mx-auto text-center px-6">
				<h1 class="text-6xl font-bold mb-6 bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent">WebSocket Chat</h1>
				<form action="" onsubmit="sendMessage(event)" class="mb-6">
					<input
						type="text"
						id="messageText"
						placeholder="Type your message..."
						autocomplete="off"
						class="px-4 py-3 rounded-lg bg-zinc-800 border border-zinc-600 text-white placeholder-gray-400 w-2/3 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" />
					<button
						type="submit"
						class="bg-primary text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-600 transition-all ml-2">
						Send
					</button>
				</form>
				<ul
					id="messages"
					class="text-left text-gray-300 bg-zinc-800 border border-zinc-600 rounded-lg p-4 max-h-96 overflow-y-scroll w-2/3 mx-auto"></ul>

				<!-- Form to send KBVECommand JSON -->
				<h2 class="text-3xl font-bold mt-8 mb-4 text-secondary">Send a KBVECommand</h2>
				<form action="" onsubmit="sendCommand(event)" class="mb-6">
					<textarea
						id="commandText"
						placeholder="Enter KBVECommand JSON..."
						class="px-4 py-3 rounded-lg bg-zinc-800 border border-zinc-600 text-white placeholder-gray-400 w-2/3 h-32 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"></textarea>
					<button
						type="submit"
						class="bg-primary text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-600 transition-all block mx-auto mt-3">
						Send Command
					</button>
				</form>
			</div>
		</section>

		<!-- Footer -->
		<footer class="bg-dark border-t border-zinc-700 text-gray-300 py-6">
			<div class="container mx-auto text-center">
				<p class="text-lg">The <span class="text-primary font-semibold">Fudster</span></p>
				<p class="text-sm text-gray-400 mt-2">Powered by KBVE Droid & Modern Web Technologies</p>
			</div>
		</footer>

		<!-- WebSocket JavaScript -->
		<script>
			// Determine WebSocket protocol and URL
			const wsProtocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
			const wsUrl = `${wsProtocol}//${location.host}/ws`;
			
			console.log('Attempting WebSocket connection to:', wsUrl);
			
			let ws;
			try {
				ws = new WebSocket(wsUrl);
			} catch (error) {
				console.error('Failed to create WebSocket:', error);
			}

			ws.onopen = function () {
				console.log('WebSocket connection established to:', wsUrl);
				var handshakeMessage = {
					command: 'handshake',
					channel: 'default',
					content:
						'Hello, server! This is the handshake message from home template.',
					timestamp: String(Date.now()),
				};
				ws.send(JSON.stringify(handshakeMessage));
			};

			ws.onclose = function (event) {
				console.log('WebSocket connection closed. Code:', event.code, 'Reason:', event.reason);
			};

			ws.onerror = function (error) {
				console.error('WebSocket error:', error);
				console.log('WebSocket URL was:', wsUrl);
			};

			ws.onmessage = function (event) {
				var messages = document.getElementById('messages');
				var message = document.createElement('li');
				message.className = 'mb-2 p-2 border-b border-gray-200';

				try {
					var data = JSON.parse(event.data);
					
					// Check if this is a Droid command response
					if (data.type === 'droid_response' || data.command) {
						var content = document.createElement('div');
						content.innerHTML = `
							<div class="font-semibold text-blue-600">Droid Response:</div>
							<div class="text-sm">${formatJsonDisplay(data)}</div>
							<div class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</div>
						`;
						
						// Also update the Droid output if available
						const droidOutput = document.getElementById('droidOutput');
						if (droidOutput) {
							droidOutput.innerHTML += `<div class="text-green-600">WebSocket Droid Response: ${JSON.stringify(data)}</div>`;
						}
					} else {
						var content = document.createElement('div');
						content.innerHTML = `
							<div class="text-sm">${formatJsonDisplay(data)}</div>
							<div class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</div>
						`;
					}
				} catch (e) {
					var content = document.createElement('div');
					content.textContent = event.data;
				}

				message.appendChild(content);
				messages.appendChild(message);
				
				// Auto-scroll to bottom
				messages.scrollTop = messages.scrollHeight;
			};

			function formatJsonDisplay(data) {
				var formatted = '';
				for (var key in data) {
					if (data.hasOwnProperty(key)) {
						formatted += `${key}: ${data[key]}  `;
					}
				}
				return formatted;
			}

			function sendMessage(event) {
				if (ws && ws.readyState === WebSocket.OPEN) {
					var input = document.getElementById('messageText');
					var message = {
						channel: 'default',
						content: input.value,
					};
					ws.send(JSON.stringify(message));
					input.value = '';
				} else {
					console.error('WebSocket is not open. Current state:', ws ? ws.readyState : 'WebSocket not initialized');
				}
				event.preventDefault();
			}

			function sendCommand(event) {
				if (ws && ws.readyState === WebSocket.OPEN) {
					var input = document.getElementById('commandText');
					try {
						var command = JSON.parse(input.value);
									// Add Droid integration flag if KBVE is available
				if (window.kbve && !command.type) {
					command.type = 'kbve_command';
					command.timestamp = Date.now();
				}
						
						ws.send(JSON.stringify(command));
						input.value = '';
						console.log('Command sent:', command);
					} catch (e) {
						console.error('Invalid JSON format for KBVECommand.');
					}
				} else {
					console.error('WebSocket is not open. Current state:', ws ? ws.readyState : 'WebSocket not initialized');
				}
				event.preventDefault();
			}
			
			// New function to send Droid commands via WebSocket
			function sendDroidCommandViaWS() {
				const commandInput = document.getElementById('droidCommand');
				const command = commandInput.value.trim();
				
				if (!command) return;
				
				if (ws && ws.readyState === WebSocket.OPEN) {
					const droidMessage = {
						type: 'droid_command',
						command: command,
						channel: 'droid',
						timestamp: Date.now()
					};
					
					ws.send(JSON.stringify(droidMessage));
					commandInput.value = '';
					
					// Also show in local output
					const outputDiv = document.getElementById('droidOutput');
					outputDiv.innerHTML += `<div class="text-blue-600">Sent via WebSocket: ${command}</div>`;
				} else {
					console.error('WebSocket is not open. Current state:', ws ? ws.readyState : 'WebSocket not initialized');
				}
			}
		</script>
	</body>
</html>
