---
import ReactDiscordEmbed from './ReactDiscordEmbed';
import type { DiscordTheme } from './DiscordService';
import { createInlineStyle } from './DiscordService';

interface Props {
  /** Discord Server ID (enable “Server Widget” in Discord → Settings → Widget) */
  serverId: string;

  /** 'dark' | 'light' | 'auto' */
  theme?: DiscordTheme;

  /** Optional invite link (for <noscript> and visible fallback) */
  inviteUrl?: string;

  /** Sizing */
  width?: number | string;   // default: 100%
  height?: number | string;  // used only when not using aspect-ratio classes
  class?: string;            // extra classes on the outer wrapper

  /** A11y title for the iframe(s) */
  title?: string;

  /** Visible fallback text inside <noscript> */
  fallbackText?: string;

  /** Use aspect ratio wrapper (recommended for RWD). Provide tailwind classes e.g. "aspect-[4/5] lg:aspect-[16/9]" */
  aspect?: string;
}

const {
  serverId,
  theme = 'auto',
  inviteUrl = `https://discord.com/invite/${serverId}`,
  width = '100%',
  height = 500,
  class: klass = '',
  title = 'Discord server widget',
  fallbackText = 'Open Discord server',
  aspect = 'aspect-[4/5] sm:aspect-[3/4] lg:aspect-[16/9]',
} = Astro.props;

const inlineStyle = createInlineStyle(width, height, aspect);
---

<!--
  Card wrapper:
  - Subtle gradient border
  - Inner shadow “3D” depth
  - Uses Starlight CSS vars to match theme
-->
<div
  data-discord-embed
  data-theme={theme}
  class={`group relative isolate ${klass}`}
  style={inlineStyle}
>
  <div
    class={`
      ${aspect ? `relative ${aspect}` : 'relative'}
      rounded-2xl
      bg-gradient-to-br from-[color:var(--sl-color-accent)]/30 via-zinc-700/40 to-zinc-800/40
      ring-1 ring-zinc-700/60
      shadow-[0_8px_30px_rgba(0,0,0,0.25)]
      backdrop-blur-sm
    `}
  >
    <div
      class="
        relative flex h-full w-full overflow-hidden rounded-2xl
        bg-[color:var(--sl-color-bg)]
        shadow-inner
        ring-1 ring-zinc-800/60
      "
    >
      <!-- Soft inner glow for depth -->
      <div
        class="
          pointer-events-none absolute inset-0 rounded-2xl
          bg-[radial-gradient(60%_40%_at_50%_0%,rgba(56,189,248,0.12),transparent_60%)]
          opacity-70 transition-opacity duration-500
          group-data-[loaded]:opacity-0
        "
        aria-hidden="true"
      ></div>

      <!-- Skeleton -->
      <div
        class="
          absolute inset-0 rounded-2xl
          bg-gradient-to-b from-zinc-800/40 to-zinc-900/60
          animate-pulse motion-reduce:animate-none
          transition-opacity duration-500
          group-data-[loaded]:opacity-0
        "
        aria-hidden="true"
      ></div>

      <ReactDiscordEmbed
        client:visible
        serverId={serverId}
        theme={theme}
        title={title}
        frameClassName="rounded-2xl"
      />

      <!-- Focus ring for accessibility when wrapper is focused via JS or container link -->
      <div
        class="pointer-events-none absolute inset-0 rounded-2xl ring-0 ring-cyan-400/0 group-focus-within:ring-2 group-focus-within:ring-cyan-400/40 transition-all"
        aria-hidden="true"
      ></div>


      <!-- noscript fallback -->
      <noscript>
        <a
          href={inviteUrl}
          target="_blank" rel="noopener noreferrer"
          class="absolute inset-0 flex items-center justify-center bg-[color:var(--sl-color-bg)] text-cyan-400 underline"
        >
          {fallbackText}
        </a>
      </noscript>
    </div>
  </div>
</div>
