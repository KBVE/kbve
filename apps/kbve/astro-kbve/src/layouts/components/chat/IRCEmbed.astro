---
interface Props {
  /** Width of the IRC embed */
  width?: number | string;
  /** Height of the IRC embed */
  height?: number | string;
  /** Additional CSS classes */
  class?: string;
  /** Title for accessibility */
  title?: string;
  /** Use aspect ratio wrapper. Provide tailwind classes e.g. "aspect-video" or "aspect-[4/3]" */
  aspect?: string;
  /** Theme variant - dark or light */
  theme?: 'dark' | 'light' | 'auto';
  /** Margin around the component */
  margin?: string;
}

const {
  width = '100%',
  height = 800,
  class: className = '',
  title = 'KBVE Chat',
  aspect = '',
  theme = 'dark',
  margin = '',
} = Astro.props;

const inlineStyle = aspect
  ? {}
  : {
      width: typeof width === 'number' ? `${width}px` : width,
      height: typeof height === 'number' ? `${height}px` : height,
    };
---

<style>
  @keyframes pulse {
    0%, 100% {
      opacity: 0.4;
    }
    50% {
      opacity: 0.7;
    }
  }

  [data-irc-embed] {
    --irc-bg-dark: rgba(24, 24, 27, 0.95);
    --irc-bg-light: rgba(255, 255, 255, 0.95);
    --irc-border-dark: rgba(63, 63, 70, 0.6);
    --irc-border-light: rgba(200, 200, 200, 0.6);
    --irc-skeleton: rgba(63, 63, 70, 0.5);
  }

  [data-irc-embed][data-theme="light"] {
    --irc-bg: var(--irc-bg-light);
    --irc-border: var(--irc-border-light);
  }

  [data-irc-embed][data-theme="dark"],
  [data-irc-embed][data-theme="auto"] {
    --irc-bg: var(--irc-bg-dark);
    --irc-border: var(--irc-border-dark);
  }

  @media (prefers-color-scheme: light) {
    [data-irc-embed][data-theme="auto"] {
      --irc-bg: var(--irc-bg-light);
      --irc-border: var(--irc-border-light);
    }
  }

  .irc-skeleton {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  [data-irc-embed][data-loaded] .irc-skeleton-container {
    display: none;
  }

  .irc-iframe {
    border: 0;
    width: 100%;
    height: 100%;
    display: block;
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
  }

  .irc-iframe-container {
    position: absolute;
    top: 1rem;
    left: 1rem;
    right: 1rem;
    bottom: 1rem;
    min-height: 600px;
  }

  [data-irc-embed] {
    display: block;
    width: 100%;
  }
</style>

<div
  data-irc-embed
  data-theme={theme}
  class={`group relative isolate block ${margin} ${className}`}
  style={inlineStyle}
  role="region"
  aria-label="IRC Chat Embed"
>
  <div
    class={`
      ${aspect && !height ? `relative ${aspect}` : 'relative'}
      rounded-2xl
      bg-zinc-900 dark:bg-zinc-900 light:bg-gray-50
      ring-1 ring-zinc-800 dark:ring-zinc-800 light:ring-gray-200
      shadow-2xl
      p-4
    `}
    style={aspect ? {} : { height: typeof height === 'number' ? `${height}px` : height }}
  >
    <!-- Loading Skeleton -->
    <div
      class="irc-skeleton-container absolute inset-4 rounded-lg overflow-hidden pointer-events-none"
      aria-hidden="true"
    >
      <div class="absolute inset-0 bg-zinc-900 dark:bg-zinc-900 light:bg-gray-100">
        <!-- Chat header skeleton -->
        <div class="h-14 border-b border-zinc-800 dark:border-zinc-800 light:border-gray-200 px-4 py-3">
          <div class="flex items-center justify-between">
            <div class="w-32 h-6 rounded bg-zinc-700 dark:bg-zinc-700 light:bg-gray-300 irc-skeleton"></div>
            <div class="flex gap-2">
              <div class="w-6 h-6 rounded bg-zinc-700 dark:bg-zinc-700 light:bg-gray-300 irc-skeleton"></div>
              <div class="w-6 h-6 rounded bg-zinc-700 dark:bg-zinc-700 light:bg-gray-300 irc-skeleton"></div>
            </div>
          </div>
        </div>

        <!-- Chat messages skeleton -->
        <div class="p-4 space-y-3">
          {[...Array(8)].map((_, i) => (
            <div class="flex gap-3" key={i}>
              <div class="w-8 h-8 rounded-full bg-zinc-700 dark:bg-zinc-700 light:bg-gray-300 irc-skeleton"></div>
              <div class="flex-1 space-y-2">
                <div class="flex items-center gap-2">
                  <div class="w-20 h-4 rounded bg-zinc-700 dark:bg-zinc-700 light:bg-gray-300 irc-skeleton"></div>
                  <div class="w-16 h-3 rounded bg-zinc-600 dark:bg-zinc-600 light:bg-gray-200 irc-skeleton"></div>
                </div>
                <div class={`h-4 rounded bg-zinc-700 dark:bg-zinc-700 light:bg-gray-300 irc-skeleton`}
                  style={`width: ${40 + Math.random() * 50}%`}></div>
              </div>
            </div>
          ))}
        </div>

        <!-- Input area skeleton -->
        <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-zinc-800 dark:border-zinc-800 light:border-gray-200">
          <div class="h-10 rounded-lg bg-zinc-700 dark:bg-zinc-700 light:bg-gray-300 irc-skeleton"></div>
        </div>
      </div>

      <!-- Loading spinner overlay -->
      <div class="absolute inset-0 flex items-center justify-center"
        role="status"
        aria-live="polite"
      >
        <div class="text-center">
          <div class="w-12 h-12 border-4 border-blue-600/30 border-t-blue-600 rounded-full animate-spin mb-3"></div>
          <p class="text-sm text-zinc-400 dark:text-zinc-400 light:text-gray-600">Connecting to chat...</p>
        </div>
      </div>
    </div>

    <!-- IRC iframe -->
    <div class="irc-iframe-container rounded-lg overflow-hidden bg-zinc-800 dark:bg-zinc-800 light:bg-gray-100">
      <iframe
        src="https://chat.kbve.com"
        title={title}
        class="irc-iframe"
        loading="lazy"
        referrerpolicy="no-referrer"
        sandbox="allow-same-origin allow-scripts allow-forms allow-popups"
        onload="this.closest('[data-irc-embed]').setAttribute('data-loaded', 'true')"
      ></iframe>
    </div>
  </div>
</div>

<script>
  // Handle iframe load events
  document.addEventListener('DOMContentLoaded', () => {
    const ircEmbeds = document.querySelectorAll('[data-irc-embed]');

    ircEmbeds.forEach((embed) => {
      const iframe = embed.querySelector('iframe');

      if (iframe) {
        // Handle errors
        iframe.addEventListener('error', () => {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'absolute inset-0 flex items-center justify-center bg-zinc-900 rounded-2xl';
          errorMsg.innerHTML = `
            <div class="text-center p-4">
              <svg class="w-12 h-12 text-red-500 mx-auto mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <p class="text-zinc-400">Failed to load chat</p>
              <button onclick="location.reload()" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                Retry
              </button>
            </div>
          `;
          iframe.replaceWith(errorMsg);
        });
      }
    });

    // Accessibility: Announce when chat loads
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'data-loaded') {
          const target = mutation.target as HTMLElement;
          if (target.hasAttribute('data-loaded')) {
            const announcement = document.createElement('div');
            announcement.className = 'sr-only';
            announcement.setAttribute('role', 'status');
            announcement.setAttribute('aria-live', 'polite');
            announcement.textContent = 'Chat has successfully loaded';
            target.appendChild(announcement);
            setTimeout(() => announcement.remove(), 1000);
          }
        }
      });
    });

    ircEmbeds.forEach((embed) => {
      observer.observe(embed, { attributes: true });
    });
  });
</script>