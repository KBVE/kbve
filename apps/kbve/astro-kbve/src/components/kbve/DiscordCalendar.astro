---
interface Event {
	title: string;
	description: string;
	date: string;
	time: string;
	type:
		| 'gaming'
		| 'community'
		| 'stream'
		| 'tournament'
		| 'meeting'
		| 'special';
	channel?: string;
}

interface Props {
	events?: Event[];
	title?: string;
	subtitle?: string;
}

// Generate upcoming Saturday dev nights
function getUpcomingSaturdays(count: number): Event[] {
	const events: Event[] = [];
	const today = new Date();
	let current = new Date(today);

	// Find next Saturday
	const daysUntilSaturday = (6 - current.getDay() + 7) % 7;
	current.setDate(
		current.getDate() + (daysUntilSaturday === 0 ? 7 : daysUntilSaturday),
	);

	for (let i = 0; i < count; i++) {
		const dateStr = current.toISOString().split('T')[0];
		events.push({
			title: 'Dev Night Stream',
			description:
				'Join us for our weekly development stream! Watch live coding, ask questions, and hang out with the community.',
			date: dateStr,
			time: '6:00 PM EST',
			type: 'stream',
			channel: '#streams',
		});
		current.setDate(current.getDate() + 7);
	}

	return events;
}

const defaultEvents: Event[] = getUpcomingSaturdays(4);

const {
	events = defaultEvents,
	title = 'Upcoming Events',
	subtitle = 'Mark your calendar and join us!',
} = Astro.props;

const typeConfig: Record<string, { label: string; color: string }> = {
	gaming: { label: 'Gaming', color: '#10B981' },
	community: { label: 'Community', color: '#8B5CF6' },
	stream: { label: 'Stream', color: '#EF4444' },
	tournament: { label: 'Tournament', color: '#F59E0B' },
	meeting: { label: 'Meeting', color: '#3B82F6' },
	special: { label: 'Special', color: '#EC4899' },
};

const icons: Record<string, string> = {
	gaming: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>`,
	community: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>`,
	stream: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"/>`,
	tournament: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>`,
	meeting: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>`,
	special: `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"/>`,
};

function formatDate(dateStr: string): {
	day: string;
	month: string;
	weekday: string;
} {
	const date = new Date(dateStr);
	return {
		day: date.getDate().toString().padStart(2, '0'),
		month: date
			.toLocaleDateString('en-US', { month: 'short' })
			.toUpperCase(),
		weekday: date.toLocaleDateString('en-US', { weekday: 'short' }),
	};
}
---

<section id="discord-calendar">
	<div class="calendar-container">
		<div class="calendar-header">
			<div class="header-glow"></div>
			<div class="header-content">
				<div class="calendar-icon">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor">
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="1.5"
							d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z">
						</path>
					</svg>
				</div>
				<h2 class="calendar-title">{title}</h2>
				<p class="calendar-subtitle">{subtitle}</p>
			</div>
		</div>

		<div class="events-timeline">
			<div class="timeline-line"></div>
			{
				events.map((event, index) => {
					const dateInfo = formatDate(event.date);
					const config = typeConfig[event.type];
					return (
						<div
							class="event-card"
							style={`--index: ${index}; --type-color: ${config.color}`}>
							<div class="event-date">
								<span class="date-day">{dateInfo.day}</span>
								<span class="date-month">{dateInfo.month}</span>
								<span class="date-weekday">
									{dateInfo.weekday}
								</span>
							</div>
							<div class="timeline-dot">
								<div class="dot-inner" />
								<div class="dot-pulse" />
							</div>
							<div class="event-content">
								<div class="event-meta">
									<span
										class="event-type"
										style={`--badge-color: ${config.color}`}>
										<svg
											xmlns="http://www.w3.org/2000/svg"
											fill="none"
											viewBox="0 0 24 24"
											stroke="currentColor"
											set:html={icons[event.type]}
										/>
										{config.label}
									</span>
									<span class="event-time">
										<svg
											xmlns="http://www.w3.org/2000/svg"
											fill="none"
											viewBox="0 0 24 24"
											stroke="currentColor">
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
											/>
										</svg>
										{event.time}
									</span>
								</div>
								<h3 class="event-title">{event.title}</h3>
								<p class="event-description">
									{event.description}
								</p>
								{event.channel && (
									<div class="event-channel">
										<svg
											xmlns="http://www.w3.org/2000/svg"
											fill="none"
											viewBox="0 0 24 24"
											stroke="currentColor">
											<path
												stroke-linecap="round"
												stroke-linejoin="round"
												stroke-width="2"
												d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"
											/>
										</svg>
										{event.channel}
									</div>
								)}
							</div>
							<div class="event-glow" />
						</div>
					);
				})
			}
		</div>

		{
			events.length === 0 && (
				<div class="no-events">
					<svg
						xmlns="http://www.w3.org/2000/svg"
						fill="none"
						viewBox="0 0 24 24"
						stroke="currentColor">
						<path
							stroke-linecap="round"
							stroke-linejoin="round"
							stroke-width="1.5"
							d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"
						/>
					</svg>
					<p>No upcoming events scheduled</p>
					<span>Check back soon!</span>
				</div>
			)
		}
	</div>
</section>

<style>
	#discord-calendar {
		--cal-bg: var(--sl-color-bg, #0d1117);
		--cal-bg-accent: var(--sl-color-bg-accent, #164e63);
		--cal-text: var(--sl-color-text, #e6edf3);
		--cal-text-muted: var(--sl-color-gray-3, #8b949e);
		--cal-border: var(--sl-color-hairline, #30363d);
		--cal-accent: var(--sl-color-accent, #06b6d4);
		--cal-accent-high: var(--sl-color-accent-high, #67e8f9);
		--octagon-cut: 1rem;
	}

	#discord-calendar {
		background: transparent;
		padding: 4rem 1rem;
	}

	.calendar-container {
		max-width: 900px;
		margin: 0 auto;
	}

	/* Header */
	.calendar-header {
		text-align: center;
		margin-bottom: 3rem;
		position: relative;
	}

	.header-glow {
		position: absolute;
		top: 50%;
		left: 50%;
		transform: translate(-50%, -50%);
		width: 400px;
		height: 200px;
		background: radial-gradient(
			ellipse,
			var(--cal-accent) 0%,
			transparent 70%
		);
		opacity: 0.08;
		filter: blur(60px);
		pointer-events: none;
	}

	.header-content {
		position: relative;
		z-index: 1;
	}

	.calendar-icon {
		width: 4rem;
		height: 4rem;
		margin: 0 auto 1.5rem;
		padding: 1rem;
		background: linear-gradient(
			135deg,
			var(--cal-accent) 0%,
			var(--cal-accent-high) 100%
		);
		border-radius: 1rem;
		display: flex;
		align-items: center;
		justify-content: center;
		box-shadow: 0 0 40px rgba(6, 182, 212, 0.3);
	}

	.calendar-icon svg {
		width: 2rem;
		height: 2rem;
		color: white;
	}

	.calendar-title {
		font-size: 2.5rem;
		font-weight: 700;
		color: var(--cal-text);
		margin: 0 0 0.75rem;
		letter-spacing: -0.02em;
	}

	.calendar-subtitle {
		font-size: 1.125rem;
		color: var(--cal-text-muted);
		margin: 0;
	}

	/* Timeline */
	.events-timeline {
		position: relative;
		display: flex;
		flex-direction: column;
		gap: 1.5rem;
	}

	.timeline-line {
		position: absolute;
		left: 5.5rem;
		top: 0;
		bottom: 0;
		width: 2px;
		background: linear-gradient(
			180deg,
			var(--cal-accent),
			var(--cal-border) 50%,
			transparent
		);
		opacity: 0.5;
	}

	@media (max-width: 640px) {
		.timeline-line {
			display: none;
		}
	}

	/* Event Card */
	.event-card {
		position: relative;
		display: grid;
		grid-template-columns: 4.5rem 2rem 1fr;
		gap: 1rem;
		align-items: start;
		padding: 1.5rem;
		background: linear-gradient(
			135deg,
			rgba(6, 182, 212, 0.05) 0%,
			transparent 100%
		);
		box-shadow: inset 0 0 0 1px var(--cal-border);
		opacity: 0;
		transform: translateX(-20px);
		animation: slideInEvent 0.5s ease forwards;
		animation-delay: calc(var(--index) * 0.1s);
		transition:
			clip-path 0.5s cubic-bezier(0.4, 0, 0.2, 1),
			box-shadow 0.5s cubic-bezier(0.4, 0, 0.2, 1),
			transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
		clip-path: polygon(
			0% 0%,
			100% 0%,
			100% 0%,
			100% 100%,
			100% 100%,
			0% 100%,
			0% 100%,
			0% 0%
		);
		overflow: hidden;
	}

	.event-card:hover {
		clip-path: polygon(
			var(--octagon-cut) 0%,
			calc(100% - var(--octagon-cut)) 0%,
			100% var(--octagon-cut),
			100% calc(100% - var(--octagon-cut)),
			calc(100% - var(--octagon-cut)) 100%,
			var(--octagon-cut) 100%,
			0% calc(100% - var(--octagon-cut)),
			0% var(--octagon-cut)
		);
		box-shadow:
			inset 0 0 0 1px var(--type-color),
			0 0 30px color-mix(in srgb, var(--type-color) 20%, transparent);
		transform: translateX(8px);
	}

	@keyframes slideInEvent {
		to {
			opacity: 1;
			transform: translateX(0);
		}
	}

	.event-glow {
		position: absolute;
		inset: 0;
		background: linear-gradient(
			135deg,
			var(--type-color) 0%,
			transparent 60%
		);
		opacity: 0;
		transition: opacity 0.5s ease;
		pointer-events: none;
		z-index: 0;
	}

	.event-card:hover .event-glow {
		opacity: 0.08;
	}

	@media (max-width: 640px) {
		.event-card {
			grid-template-columns: 1fr;
			gap: 0.75rem;
		}
	}

	/* Date */
	.event-date {
		display: flex;
		flex-direction: column;
		align-items: center;
		text-align: center;
		position: relative;
		z-index: 1;
	}

	.date-day {
		font-size: 1.75rem;
		font-weight: 700;
		color: var(--cal-text);
		line-height: 1;
	}

	.date-month {
		font-size: 0.75rem;
		font-weight: 600;
		color: var(--type-color);
		letter-spacing: 0.05em;
	}

	.date-weekday {
		font-size: 0.625rem;
		color: var(--cal-text-muted);
		text-transform: uppercase;
		margin-top: 0.25rem;
	}

	@media (max-width: 640px) {
		.event-date {
			flex-direction: row;
			gap: 0.75rem;
			justify-content: flex-start;
		}
	}

	/* Timeline Dot */
	.timeline-dot {
		position: relative;
		display: flex;
		align-items: center;
		justify-content: center;
		width: 2rem;
		height: 2rem;
		z-index: 2;
	}

	.dot-inner {
		width: 0.75rem;
		height: 0.75rem;
		background: var(--type-color);
		border-radius: 50%;
		position: relative;
		z-index: 1;
	}

	.dot-pulse {
		position: absolute;
		width: 1.5rem;
		height: 1.5rem;
		background: var(--type-color);
		border-radius: 50%;
		opacity: 0;
		animation: pulse 2s ease-out infinite;
		animation-delay: calc(var(--index) * 0.2s);
	}

	@keyframes pulse {
		0% {
			transform: scale(0.5);
			opacity: 0.5;
		}
		100% {
			transform: scale(1.5);
			opacity: 0;
		}
	}

	@media (max-width: 640px) {
		.timeline-dot {
			display: none;
		}
	}

	/* Event Content */
	.event-content {
		position: relative;
		z-index: 1;
	}

	.event-meta {
		display: flex;
		flex-wrap: wrap;
		gap: 0.75rem;
		margin-bottom: 0.75rem;
	}

	.event-type {
		display: inline-flex;
		align-items: center;
		gap: 0.375rem;
		font-size: 0.75rem;
		font-weight: 600;
		color: var(--badge-color);
		background: color-mix(in srgb, var(--badge-color) 15%, transparent);
		padding: 0.25rem 0.625rem;
		border-radius: 1rem;
	}

	.event-type svg {
		width: 0.875rem;
		height: 0.875rem;
	}

	.event-time {
		display: inline-flex;
		align-items: center;
		gap: 0.375rem;
		font-size: 0.75rem;
		color: var(--cal-text-muted);
	}

	.event-time svg {
		width: 0.875rem;
		height: 0.875rem;
	}

	.event-title {
		font-size: 1.125rem;
		font-weight: 600;
		color: var(--cal-text);
		margin: 0 0 0.5rem;
		line-height: 1.3;
	}

	.event-description {
		font-size: 0.875rem;
		color: var(--cal-text-muted);
		margin: 0;
		line-height: 1.6;
	}

	.event-channel {
		display: inline-flex;
		align-items: center;
		gap: 0.375rem;
		font-size: 0.75rem;
		color: var(--cal-accent);
		margin-top: 0.75rem;
		font-family: monospace;
	}

	.event-channel svg {
		width: 0.875rem;
		height: 0.875rem;
	}

	/* No Events */
	.no-events {
		text-align: center;
		padding: 4rem 2rem;
		color: var(--cal-text-muted);
	}

	.no-events svg {
		width: 4rem;
		height: 4rem;
		margin-bottom: 1rem;
		opacity: 0.5;
	}

	.no-events p {
		font-size: 1.125rem;
		margin: 0 0 0.5rem;
		color: var(--cal-text);
	}

	.no-events span {
		font-size: 0.875rem;
	}

	/* Reduced motion */
	@media (prefers-reduced-motion: reduce) {
		.event-card {
			animation: none;
			opacity: 1;
			transform: none;
		}

		.event-card:hover {
			transform: none;
		}

		.dot-pulse {
			animation: none;
		}
	}
</style>
