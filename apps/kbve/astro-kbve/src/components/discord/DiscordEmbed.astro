---
import ReactDiscordEmbed from './ReactDiscordEmbed';
import type { DiscordTheme } from './DiscordService';

interface Props {
	/** Discord Server ID (enable "Server Widget" in Discord → Settings → Widget) */
	serverId: string;
	/** 'dark' | 'light' | 'auto' */
	theme?: DiscordTheme;
	/** Optional invite link (for <noscript> fallback) */
	inviteUrl?: string;
	/** Extra classes on the outer wrapper */
	class?: string;
	/** A11y title for the iframe */
	title?: string;
	/** Visible fallback text inside <noscript> */
	fallbackText?: string;
}

const {
	serverId,
	theme = 'auto',
	inviteUrl = `https://discord.com/invite/${serverId}`,
	class: klass = '',
	title = 'Discord server widget',
	fallbackText = 'Open Discord server',
} = Astro.props;
---

<div
	id="discord-embed"
	data-discord-embed
	data-theme={theme}
	class:list={['de-wrapper', klass]}
	role="region"
	aria-label={`Discord server widget for server ${serverId}`}>
	<div class="de-card">
		<div class="de-inner">
			<!-- Skeleton loader -->
			<div class="de-skeleton" aria-hidden="true">
				<div class="de-skeleton-header"></div>
				<div class="de-skeleton-content">
					<div class="de-skeleton-line"></div>
					<div class="de-skeleton-line short"></div>
					<div class="de-skeleton-line"></div>
				</div>
			</div>

			<!-- React embed component -->
			<ReactDiscordEmbed
				client:visible
				serverId={serverId}
				theme={theme}
				title={title}
			/>

			<!-- noscript fallback -->
			<noscript>
				<a
					href={inviteUrl}
					target="_blank"
					rel="noopener noreferrer"
					class="de-fallback"
					aria-label={`Join Discord server ${serverId} (opens in new tab)`}>
					{fallbackText}
				</a>
			</noscript>
		</div>
	</div>
</div>

<style>
	#discord-embed {
		--de-accent: var(--sl-color-accent, #5865f2);
		--de-bg: var(--sl-color-bg, #1e1e2e);
		--de-bg-nav: var(--sl-color-bg-nav, #181825);
		--de-border: var(--sl-color-border, #313244);
		--de-text: var(--sl-color-text, #cdd6f4);
		--de-text-accent: var(--sl-color-text-accent, #89b4fa);
	}

	.de-wrapper {
		position: relative;
		width: 100%;
		aspect-ratio: 4 / 5;
	}

	@media (min-width: 640px) {
		.de-wrapper {
			aspect-ratio: 3 / 4;
		}
	}

	@media (min-width: 1024px) {
		.de-wrapper {
			aspect-ratio: 16 / 9;
		}
	}

	.de-card {
		position: relative;
		height: 100%;
		padding: 2px;
		border-radius: 1rem;
		background: linear-gradient(
			135deg,
			color-mix(in srgb, var(--de-accent) 40%, transparent),
			var(--de-border) 50%,
			color-mix(in srgb, var(--de-accent) 20%, transparent)
		);
		box-shadow:
			0 4px 20px rgba(0, 0, 0, 0.3),
			0 0 40px color-mix(in srgb, var(--de-accent) 10%, transparent);
	}

	.de-inner {
		position: relative;
		display: flex;
		flex-direction: column;
		height: 100%;
		overflow: hidden;
		border-radius: calc(1rem - 2px);
		background: var(--de-bg);
		box-shadow: inset 0 1px 0 color-mix(in srgb, white 5%, transparent);
	}

	/* Skeleton loader */
	.de-skeleton {
		position: absolute;
		inset: 0;
		display: flex;
		flex-direction: column;
		padding: 1rem;
		background: var(--de-bg-nav);
		opacity: 1;
		transition: opacity 0.4s ease-out;
	}

	#discord-embed[data-loaded] .de-skeleton {
		opacity: 0;
		pointer-events: none;
	}

	.de-skeleton-header {
		height: 3rem;
		margin-bottom: 1rem;
		border-radius: 0.5rem;
		background: linear-gradient(
			90deg,
			var(--de-border) 25%,
			color-mix(in srgb, var(--de-border) 50%, var(--de-bg)) 50%,
			var(--de-border) 75%
		);
		background-size: 200% 100%;
		animation: de-shimmer 1.5s infinite;
	}

	.de-skeleton-content {
		flex: 1;
		display: flex;
		flex-direction: column;
		gap: 0.75rem;
	}

	.de-skeleton-line {
		height: 1rem;
		border-radius: 0.25rem;
		background: linear-gradient(
			90deg,
			var(--de-border) 25%,
			color-mix(in srgb, var(--de-border) 50%, var(--de-bg)) 50%,
			var(--de-border) 75%
		);
		background-size: 200% 100%;
		animation: de-shimmer 1.5s infinite;
	}

	.de-skeleton-line.short {
		width: 60%;
	}

	@keyframes de-shimmer {
		0% {
			background-position: 200% 0;
		}
		100% {
			background-position: -200% 0;
		}
	}

	/* Fallback link */
	.de-fallback {
		position: absolute;
		inset: 0;
		display: flex;
		align-items: center;
		justify-content: center;
		background: var(--de-bg);
		color: var(--de-text-accent);
		text-decoration: underline;
		font-weight: 500;
	}

	.de-fallback:focus {
		outline: 2px solid var(--de-accent);
		outline-offset: -2px;
	}

	/* Reduced motion */
	@media (prefers-reduced-motion: reduce) {
		.de-skeleton-header,
		.de-skeleton-line {
			animation: none;
		}
	}
</style>
