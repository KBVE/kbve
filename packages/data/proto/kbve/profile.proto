syntax = "proto3";

package kbve.profile;

import "kbve/common.proto";

// =============================================================================
// Profile - User profile data for public display
// =============================================================================

// Provider identity information (Discord, GitHub, etc.)
message ProviderInfo {
  string provider = 1;        // "discord", "github", etc.
  string provider_id = 2;     // Provider-specific user ID
  optional string username = 3;
  optional string avatar_url = 4;
  optional string email = 5;  // May be hidden based on privacy settings
  optional string linked_at = 6;
  optional string last_sign_in_at = 7;
}

// Discord-specific profile information
message DiscordProfile {
  string id = 1;              // Discord user ID
  optional string username = 2;
  optional string discriminator = 3;  // Legacy discriminator if applicable
  optional string avatar_url = 4;
  optional string banner_url = 5;
  optional int32 accent_color = 6;
}

// GitHub-specific profile information
message GithubProfile {
  string id = 1;              // GitHub user ID
  optional string username = 2;
  optional string avatar_url = 3;
  optional string bio = 4;
  optional string company = 5;
  optional string location = 6;
  optional string blog = 7;
  optional int32 public_repos = 8;
  optional int32 followers = 9;
  optional int32 following = 10;
}

// Complete user profile
message UserProfile {
  string user_id = 1;         // UUID from Supabase auth
  string username = 2;        // 3-24 chars, alphanumeric + underscore, starts with letter
  optional string display_name = 3;
  optional string bio = 4;
  optional string avatar_url = 5;

  // Linked providers
  repeated ProviderInfo providers = 6;
  optional DiscordProfile discord = 7;
  optional GithubProfile github = 8;

  // Profile metadata
  optional string created_at = 9;
  optional string updated_at = 10;

  // Privacy flags
  bool is_public = 11;        // default: true for kbve.com/@username
  bool show_providers = 12;   // default: true

  reserved 13;  // was: RentEarth game data (removed)
}

// =============================================================================
// Profile Requests/Responses for RPC
// =============================================================================

// Request to lookup user by username
message GetProfileByUsernameRequest {
  string username = 1;  // Will be validated and lowercased
}

// Request to lookup user by ID
message GetProfileByIdRequest {
  string user_id = 1;  // UUID
}

// Response containing user profile
message GetProfileResponse {
  bool found = 1;
  optional UserProfile profile = 2;
  optional string error = 3;
}

// =============================================================================
// Username Validation
// =============================================================================

// Username validation error types
enum UsernameErrorType {
  USERNAME_ERROR_UNSPECIFIED = 0;
  USERNAME_ERROR_EMPTY = 1;
  USERNAME_ERROR_TOO_SHORT = 2;
  USERNAME_ERROR_TOO_LONG = 3;
  USERNAME_ERROR_INVALID_CHARS = 4;
  USERNAME_ERROR_MUST_START_WITH_LETTER = 5;
  USERNAME_ERROR_RESERVED = 6;
}

// Username validation result
message UsernameValidation {
  bool valid = 1;
  optional string normalized = 2;  // Lowercased, trimmed username if valid
  optional UsernameErrorType error_type = 3;
  optional string error_message = 4;
}
