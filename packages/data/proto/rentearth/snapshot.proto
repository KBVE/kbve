syntax = "proto3";

package rentearth.snapshot;

import "rentearth/terrain.proto";

// ============================================================================
// House Naming System
// ============================================================================
//
// Characters use a "House" naming system inspired by Game of Thrones.
// Each player has ONE unique username per Supabase UUID (e.g., "Fudster", "h0lybyte").
// Each character has their own first_name which does NOT need to be unique.
//
// Display name format: "first_name of Haus username"
// Example: "Delta of Haus Fudster"
//
// Fields:
//   - first_name:   Character's given name (stored in rentearth.character.first_name)
//   - username:     Player's account username (from Supabase auth.users)
//   - display_name: Constructed string "first_name of Haus username"
//
// This system allows:
//   - Multiple characters per player, each with a unique identity
//   - Quick identification of character ownership ("of Haus X")
//   - Flexible naming (first_name doesn't need to be unique server-wide)
//
// ============================================================================

// ============================================================================
// Core Data Types
// ============================================================================

message Vec3 {
  float x = 1;
  float y = 2;
  float z = 3;
}

message Quat {
  float x = 1;
  float y = 2;
  float z = 3;
  float w = 4;
}

// ============================================================================
// Entity Model - Core Types
// ============================================================================
//
// The entity model consists of 5 fields:
//   - character_type:   i32 enum  - What kind of entity (PLAYER, NPC, MONSTER, etc.)
//   - behavior_flags:   i64 bits  - How it acts (HOSTILE, FRIENDLY, PASSIVE, etc.)
//   - emotional_flags:  i64 bits  - Current emotional state (HAPPY, ANGRY, etc.)
//   - archetype_flags:  i64 bits  - Unlocked classes (WARRIOR, MAGE, MERCHANT, etc.)
//   - visual_type:      i32 enum  - 3D model/prefab to render
// ============================================================================

// CharacterType - What kind of entity is this (mutually exclusive)
enum CharacterType {
  CHARACTER_TYPE_PLAYER = 0;      // Human-controlled player
  CHARACTER_TYPE_NPC = 1;         // Friendly/neutral NPCs (merchants, quest givers)
  CHARACTER_TYPE_MONSTER = 2;     // Basic hostile enemies
  CHARACTER_TYPE_BOSS = 3;        // Boss enemies
  CHARACTER_TYPE_COMPANION = 4;   // Party companion (AI-controlled, on player's side)
}

// VisualType - Which 3D model/prefab to render (mutually exclusive)
enum VisualType {
  VISUAL_TYPE_HUMAN_MALE = 0;
  VISUAL_TYPE_HUMAN_FEMALE = 1;
  VISUAL_TYPE_SKELETON_WARRIOR = 2;
  VISUAL_TYPE_SKELETON_MAGE = 3;
  VISUAL_TYPE_SKELETON_MINION = 4;
  VISUAL_TYPE_SKELETON_ROGUE = 5;
  VISUAL_TYPE_GOBLIN = 6;
  VISUAL_TYPE_ORC = 7;
  // Add more as needed
}

// ============================================================================
// Behavior Flags (i64 bitfield) - How the entity acts
// ============================================================================
// Use: behavior_flags & BEHAVIOR_HOSTILE != 0
//
// BEHAVIOR_HOSTILE       = 1 << 0  = 1       - Attacks players on sight
// BEHAVIOR_FRIENDLY      = 1 << 1  = 2       - Won't attack, can interact
// BEHAVIOR_PASSIVE       = 1 << 2  = 4       - Won't attack unless provoked
// BEHAVIOR_AGGRESSIVE    = 1 << 3  = 8       - Actively seeks targets
// BEHAVIOR_INVULNERABLE  = 1 << 4  = 16      - Cannot take damage
// BEHAVIOR_UNTARGETABLE  = 1 << 5  = 32      - Cannot be targeted
// BEHAVIOR_STATIONARY    = 1 << 6  = 64      - Does not move
// BEHAVIOR_PATROL        = 1 << 7  = 128     - Follows patrol route
// BEHAVIOR_FLEE          = 1 << 8  = 256     - Runs away when low health
// BEHAVIOR_GUARD         = 1 << 9  = 512     - Protects an area/entity
// BEHAVIOR_MERCHANT      = 1 << 10 = 1024    - Can trade with players
// BEHAVIOR_QUEST_GIVER   = 1 << 11 = 2048    - Has quests available

// ============================================================================
// Emotional Flags (i64 bitfield) - Current emotional state
// ============================================================================
// Use: emotional_flags & EMOTION_HAPPY != 0
//
// EMOTION_NEUTRAL   = 1 << 0  = 1       - Default state
// EMOTION_HAPPY     = 1 << 1  = 2       - Positive mood
// EMOTION_ANGRY     = 1 << 2  = 4       - Hostile mood
// EMOTION_SCARED    = 1 << 3  = 8       - Fear state
// EMOTION_CONFUSED  = 1 << 4  = 16      - Disoriented
// EMOTION_SAD       = 1 << 5  = 32      - Negative mood
// EMOTION_EXCITED   = 1 << 6  = 64      - High energy
// EMOTION_CALM      = 1 << 7  = 128     - Relaxed state
// EMOTION_SURPRISED = 1 << 8  = 256     - Startled
// EMOTION_DISGUSTED = 1 << 9  = 512     - Revulsion

// ============================================================================
// Archetype Flags (i64 bitfield) - Unlocked classes/professions
// ============================================================================
// Players can have MULTIPLE archetypes unlocked
// Use: archetype_flags & ARCHETYPE_WARRIOR != 0
//
// ARCHETYPE_WARRIOR    = 1 << 0  = 1       - Melee combat specialist
// ARCHETYPE_MAGE       = 1 << 1  = 2       - Magic/spells
// ARCHETYPE_ROGUE      = 1 << 2  = 4       - Stealth/agility
// ARCHETYPE_MERCHANT   = 1 << 3  = 8       - Trading/economy
// ARCHETYPE_CRAFTSMAN  = 1 << 4  = 16      - Building/crafting
// ARCHETYPE_FARMER     = 1 << 5  = 32      - Agriculture/animals
// ARCHETYPE_EXPLORER   = 1 << 6  = 64      - Discovery/mapping
// ARCHETYPE_HEALER     = 1 << 7  = 128     - Support/healing
// ARCHETYPE_RANGER     = 1 << 8  = 256     - Ranged combat/nature
// ARCHETYPE_BARD       = 1 << 9  = 512     - Music/buffs
// ARCHETYPE_NECROMANCER = 1 << 10 = 1024   - Dark magic/undead
// ARCHETYPE_PALADIN    = 1 << 11 = 2048    - Holy warrior

// ============================================================================
// Animation State (i32 enum) - Base locomotion (mutually exclusive)
// ============================================================================
// Only one base locomotion state can be active at a time
enum AnimationState {
  ANIMATION_STATE_IDLE = 0;
  ANIMATION_STATE_WALK = 1;
  ANIMATION_STATE_RUN = 2;
  ANIMATION_STATE_JUMP = 3;
  ANIMATION_STATE_FALL = 4;
  ANIMATION_STATE_LAND = 5;
  ANIMATION_STATE_CROUCH = 6;
  ANIMATION_STATE_SWIM = 7;
  ANIMATION_STATE_CLIMB = 8;
  ANIMATION_STATE_DEAD = 9;
}

// ============================================================================
// Action Flags (u32 bitfield) - Player input intentions
// ============================================================================
// What the player WANTS to do (input from client)
// Used in: PlayerInput.action_flags
enum ActionFlag {
  ACTION_FLAG_NONE = 0;

  // Movement intentions (bits 0-3)
  ACTION_FLAG_JUMP = 1;                     // 1 << 0  - Player wants to jump
  ACTION_FLAG_SPRINT = 2;                   // 1 << 1  - Player holding sprint
  ACTION_FLAG_CROUCH = 4;                   // 1 << 2  - Player wants to crouch
  ACTION_FLAG_DODGE = 8;                    // 1 << 3  - Player wants to dodge/roll

  // Combat intentions (bits 4-7)
  ACTION_FLAG_ATTACK = 16;                  // 1 << 4  - Primary attack
  ACTION_FLAG_HEAVY_ATTACK = 32;            // 1 << 5  - Heavy/charged attack
  ACTION_FLAG_BLOCK = 64;                   // 1 << 6  - Block/defend
  ACTION_FLAG_PARRY = 128;                  // 1 << 7  - Parry attempt

  // Ability intentions (bits 8-11)
  ACTION_FLAG_USE_ABILITY_1 = 256;          // 1 << 8  - Ability slot 1
  ACTION_FLAG_USE_ABILITY_2 = 512;          // 1 << 9  - Ability slot 2
  ACTION_FLAG_USE_ABILITY_3 = 1024;         // 1 << 10 - Ability slot 3
  ACTION_FLAG_USE_ABILITY_4 = 2048;         // 1 << 11 - Ability slot 4

  // Interaction intentions (bits 12-15)
  ACTION_FLAG_INTERACT = 4096;              // 1 << 12 - Generic interact (E key)
  ACTION_FLAG_USE_ITEM = 8192;              // 1 << 13 - Use held item
  ACTION_FLAG_RELOAD = 16384;               // 1 << 14 - Reload/recharge
  ACTION_FLAG_CANCEL = 32768;               // 1 << 15 - Cancel current action

  // Reserved: bits 16-31 for future use
}

// ============================================================================
// Combat State (i32 enum) - Mutually exclusive combat states
// ============================================================================
// Only one combat state can be active at a time
enum CombatState {
  COMBAT_STATE_NONE = 0;                    // Not in combat
  COMBAT_STATE_IDLE = 1;                    // In combat, ready stance
  COMBAT_STATE_ATTACKING = 2;               // Performing attack
  COMBAT_STATE_BLOCKING = 3;                // Actively blocking
  COMBAT_STATE_PARRYING = 4;                // In parry window
  COMBAT_STATE_DODGING = 5;                 // Dodge roll/dash i-frames
  COMBAT_STATE_STUNNED = 6;                 // Stunned/dazed
  COMBAT_STATE_KNOCKED_DOWN = 7;            // On the ground
  COMBAT_STATE_GETTING_UP = 8;              // Rising from knockdown
  COMBAT_STATE_CASTING = 9;                 // Casting spell (locked)
  COMBAT_STATE_CHANNELING = 10;             // Channeling spell (can move)
}

// ============================================================================
// Combat Flags (i32 bitfield) - Combinable combat modifiers
// ============================================================================
// Multiple can be active (e.g., IN_COMBAT | HEAVY_ATTACK | CRITICAL)
enum CombatFlag {
  COMBAT_FLAG_NONE = 0;

  // Combat status (bits 0-3)
  COMBAT_FLAG_IN_COMBAT = 1;                // 1 << 0  - Currently in combat
  COMBAT_FLAG_HEAVY_ATTACK = 2;             // 1 << 1  - Attack is heavy/charged
  COMBAT_FLAG_COMBO = 4;                    // 1 << 2  - Part of combo chain
  COMBAT_FLAG_CRITICAL = 8;                 // 1 << 3  - Critical hit pending

  // Combat modifiers (bits 4-7)
  COMBAT_FLAG_SUPER_ARMOR = 16;             // 1 << 4  - Cannot be interrupted
  COMBAT_FLAG_INVULNERABLE = 32;            // 1 << 5  - Cannot take damage
  COMBAT_FLAG_PARRY_WINDOW = 64;            // 1 << 6  - In parry timing window
  COMBAT_FLAG_COUNTER_READY = 128;          // 1 << 7  - Can counter attack

  // Targeting (bits 8-10)
  COMBAT_FLAG_LOCKED_ON = 256;              // 1 << 8  - Locked onto target
  COMBAT_FLAG_AUTO_TARGET = 512;            // 1 << 9  - Auto-targeting enabled
  COMBAT_FLAG_AOE_MODE = 1024;              // 1 << 10 - Area attack mode

  // Reserved: bits 11-30 for future use
}

// ============================================================================
// Animation Flags (i32 bitfield) - Visual animation modifiers
// ============================================================================
// Layered visual states (e.g., HURT | BURNING while running)
// Note: Combat animations are driven by CombatState, not AnimationFlag
enum AnimationFlag {
  ANIMATION_FLAG_NONE = 0;

  // Status effect visuals (bits 0-7)
  ANIMATION_FLAG_HURT = 1;                  // 1 << 0  - Taking damage flinch
  ANIMATION_FLAG_POISONED = 2;              // 1 << 1  - Poison visual effect
  ANIMATION_FLAG_BURNING = 4;               // 1 << 2  - On fire visual
  ANIMATION_FLAG_FROZEN = 8;                // 1 << 3  - Frozen/slowed visual
  ANIMATION_FLAG_ELECTRIFIED = 16;          // 1 << 4  - Electric shock visual
  ANIMATION_FLAG_HEALING = 32;              // 1 << 5  - Receiving heal visual
  ANIMATION_FLAG_BLESSED = 64;              // 1 << 6  - Divine buff visual
  ANIMATION_FLAG_CURSED = 128;              // 1 << 7  - Curse/debuff visual

  // Interaction states (bits 8-11)
  ANIMATION_FLAG_HARVESTING = 256;          // 1 << 8  - Gathering resources
  ANIMATION_FLAG_CRAFTING = 512;            // 1 << 9  - At crafting station
  ANIMATION_FLAG_INTERACTING = 1024;        // 1 << 10 - Generic interaction
  ANIMATION_FLAG_SITTING = 2048;            // 1 << 11 - Sitting down

  // Movement modifiers (bits 12-14)
  ANIMATION_FLAG_SPRINTING = 4096;          // 1 << 12 - Sprint modifier
  ANIMATION_FLAG_EXHAUSTED = 8192;          // 1 << 13 - Low stamina movement
  ANIMATION_FLAG_ENCUMBERED = 16384;        // 1 << 14 - Overweight movement

  // Social/emote (bits 15-17)
  ANIMATION_FLAG_TALKING = 32768;           // 1 << 15 - In conversation
  ANIMATION_FLAG_EMOTING = 65536;           // 1 << 16 - Playing emote (use emote_id for specific)
  ANIMATION_FLAG_AFK = 131072;              // 1 << 17 - Away from keyboard idle

  // Reserved: bits 18-30 for future use
}

// ============================================================================
// Persistent Character State (stored in rentearth.character_state.state_proto)
// ============================================================================
//
// @sql.table: rentearth.character_stats (HOT) + rentearth.character_state (COLD)
// @sql.mapping:
//   position.x    -> character_stats.world_x (real)
//   position.y    -> character_stats.world_y (real)
//   position.z    -> character_stats.world_z (real)
//   rotation_yaw  -> character_stats.rotation_yaw (real)
//   health_current -> character_stats.health_current (integer, cast from float)
//   health_max     -> character_stats.health_max (integer)
//   mana_current   -> character_stats.mana_current (integer)
//   mana_max       -> character_stats.mana_max (integer)
//   energy_current -> character_stats.stamina_current (integer, renamed)
//   energy_max     -> character_stats.stamina_max (integer, renamed)
//   current_zone_id -> character_stats.current_zone (text, lookup)
//   quest_flags    -> character_progress.story_flags (bigint)
//   achievement_flags -> character_progress.achievement_flags (bigint)
//   play_time_seconds -> character_stats.total_playtime (interval)
//   [full message]  -> character_state.state_proto (bytea, serialized)
// ============================================================================

// Character state blob stored in database
// Contains position, stats, and runtime state that persists across sessions
message rentearthCharacterState {
  // Last known position (for spawn on reconnect)
  // @sql: character_stats.world_x/y/z (real)
  Vec3 position = 1;

  // @sql: character_stats.rotation_yaw (real)
  float rotation_yaw = 2;           // Y-axis rotation in radians

  // Progression (denormalized from character table for quick access)
  // @sql: rentearth.character.level (integer)
  int32 level = 3;
  // @sql: rentearth.character.experience (bigint)
  int64 experience = 4;

  // Stats snapshot
  // @sql: character_stats.health_current (integer)
  float health_current = 5;
  // @sql: character_stats.health_max (integer)
  float health_max = 6;
  // @sql: character_stats.mana_current (integer)
  float mana_current = 7;
  // @sql: character_stats.mana_max (integer)
  float mana_max = 8;
  // @sql: character_stats.stamina_current (integer) - renamed from energy
  float energy_current = 9;
  // @sql: character_stats.stamina_max (integer) - renamed from energy
  float energy_max = 10;

  // Combat/gameplay state
  // @sql: COLD only (not queryable)
  int64 last_combat_time_ms = 11;   // For rested XP calculations
  // @sql: character_stats.current_zone (text) - zone_id lookup
  int32 current_zone_id = 12;       // For zone-based spawning

  // State flags
  // @sql: COLD only (not queryable)
  bool is_resting = 13;
  bool is_in_combat = 14;
  bool is_dead = 15;

  // Quest/story progress (compact flags)
  // @sql: character_progress.story_flags (bigint)
  int64 quest_flags = 16;           // Bitfield for quest completion
  // @sql: character_progress.achievement_flags (bigint)
  int64 achievement_flags = 17;     // Bitfield for achievements

  // Timestamps
  // @sql: COLD only (not queryable)
  int64 last_save_time_ms = 18;
  // @sql: character_stats.total_playtime (interval)
  int64 play_time_seconds = 19;     // Total time played on this character

  // New Entity Model Fields
  // @sql: rentearth.character.visual_type (integer)
  int32 visual_type = 20;           // VisualType enum (HUMAN_MALE, etc.)
  // @sql: rentearth.character.behavior_flags (bigint)
  int64 behavior_flags = 21;        // BehaviorFlags bitfield
  // @sql: rentearth.character.emotional_flags (bigint)
  int64 emotional_flags = 22;       // EmotionalFlags bitfield
  // @sql: rentearth.character.archetype_flags (bigint)
  int64 archetype_flags = 23;       // ArchetypeFlags bitfield (WARRIOR | MAGE, etc.)
}

// ============================================================================
// Snapshot System (New - for tick-based networking)
// ============================================================================

// Per-entity snapshot data sent each tick
// Fields are optional to support delta compression - only changed fields are sent
// The presence_mask indicates which fields are included in this update
message EntitySnapshot {
  bytes entity_id = 1;              // 16 bytes UUID - always required
  uint32 presence_mask = 2;         // Bitfield: which optional fields are present
                                    // See PRESENCE_* constants below

  // Transform (check presence_mask)
  Vec3 position = 3;
  Quat rotation = 4;
  Vec3 velocity = 5;                // For client-side prediction/extrapolation

  // Identity - House Naming System:
  //   - first_name: Character's given name (e.g., "Delta")
  //   - username: Player's account username (e.g., "Fudster")
  //   - display_name: Full display name "first_name of Haus username" (e.g., "Delta of Haus Fudster")
  //   For NPCs/monsters: display_name is just their name, first_name/username may be empty
  string first_name = 25;           // Character's first name (players only)
  string username = 26;             // Player's username from Supabase (players only)
  string display_name = 6;          // Full display name (kept at field 6 for compatibility)

  int32 character_type = 7;         // CharacterType enum (PLAYER, NPC, MONSTER, etc.)
  int32 visual_type = 8;            // VisualType enum (HUMAN_MALE, SKELETON, etc.)

  // Flags (i64 bitfields)
  int64 behavior_flags = 9;         // BehaviorFlags (HOSTILE, FRIENDLY, etc.)
  int64 emotional_flags = 10;       // EmotionalFlags (HAPPY, ANGRY, etc.)
  int64 archetype_flags = 11;       // ArchetypeFlags (WARRIOR, MAGE, etc.)

  // Animation state
  int32 animation_state = 12;       // AnimationState enum (base locomotion)
  int32 animation_flags = 22;       // AnimationFlag bitfield (visual modifiers)

  // Combat state
  int32 combat_state = 23;          // CombatState enum (attacking, blocking, etc.)
  int32 combat_flags = 24;          // CombatFlag bitfield (in_combat, combo, etc.)

  // Health
  float health = 13;
  float max_health = 14;
  bool is_alive = 15;

  // Metadata
  bool is_full_snapshot = 16;       // True for new entities, false for deltas
}

// Presence mask bits for EntitySnapshot
// Use these constants to check/set which fields are present
// PRESENCE_POSITION        = 1 << 0  = 1
// PRESENCE_ROTATION        = 1 << 1  = 2
// PRESENCE_VELOCITY        = 1 << 2  = 4
// PRESENCE_DISPLAY_NAME    = 1 << 3  = 8
// PRESENCE_CHARACTER_TYPE  = 1 << 4  = 16
// PRESENCE_VISUAL_TYPE     = 1 << 5  = 32
// PRESENCE_BEHAVIOR_FLAGS  = 1 << 6  = 64
// PRESENCE_EMOTIONAL_FLAGS = 1 << 7  = 128
// PRESENCE_ARCHETYPE_FLAGS = 1 << 8  = 256
// PRESENCE_ANIMATION_STATE = 1 << 9  = 512
// PRESENCE_ANIMATION_FLAGS = 1 << 10 = 1024
// PRESENCE_COMBAT_STATE    = 1 << 11 = 2048
// PRESENCE_COMBAT_FLAGS    = 1 << 12 = 4096
// PRESENCE_HEALTH          = 1 << 13 = 8192
// PRESENCE_MAX_HEALTH      = 1 << 14 = 16384
// PRESENCE_IS_ALIVE        = 1 << 15 = 32768
// PRESENCE_FIRST_NAME      = 1 << 16 = 65536    // House naming: character first name
// PRESENCE_USERNAME        = 1 << 17 = 131072   // House naming: player username

// World snapshot sent at 10 Hz to each client
message WorldSnapshot {
  uint64 tick = 1;                          // Server tick number
  int64 server_time_ms = 2;                 // Server timestamp for time sync
  repeated EntitySnapshot entities = 3;     // Entities in view
  repeated bytes removed_entity_ids = 4;    // Entities that left view
}

// Player input sent from client to server
message PlayerInput {
  uint32 sequence = 1;              // Input sequence number (for ack/reconciliation)
  int64 client_time_ms = 2;         // Client timestamp
  Vec3 move_direction = 3;          // Normalized movement vector
  Quat look_rotation = 4;           // Camera/character rotation
  uint32 action_flags = 5;          // ActionFlag bitfield (player intentions)
  uint64 target_object_id = 6;      // Target for interactions
  int32 animation_state = 7;        // AnimationState enum (base locomotion)
  int32 animation_flags = 9;        // AnimationFlag bitfield (visual modifiers)
  int32 combat_state = 10;          // CombatState enum (client's current combat state)
  int32 combat_flags = 11;          // CombatFlag bitfield (combat modifiers)
  Vec3 position = 8;                // Client's actual world position (for chunk streaming)
}

// ============================================================================
// Connection State (synchronized between server and client)
// ============================================================================

// Bitflags for connection state - must match Unity ConnectionStateFlags
// Server is authoritative - sends current flags with state-changing messages
// Client validates local state matches server state
enum ConnectionStateFlag {
  CONNECTION_STATE_NONE = 0;
  CONNECTION_STATE_CONNECTED = 1;           // 1 << 0: WebSocket connected
  CONNECTION_STATE_AUTHENTICATED = 2;       // 1 << 1: JWT verified
  CONNECTION_STATE_HAS_UUID = 4;            // 1 << 2: User ID established
  CONNECTION_STATE_HAS_USERNAME = 8;        // 1 << 3: Username registered
  CONNECTION_STATE_CLIENT_READY = 16;       // 1 << 4: ClientReady sent
  CONNECTION_STATE_SERVER_READY = 32;       // 1 << 5: Server acknowledged
  CONNECTION_STATE_GAME_ACTIVE = 64;        // 1 << 6: Full game session
  CONNECTION_STATE_IN_GAME = 128;           // 1 << 7: Player in world
}

// Connection state sync message - sent on every state change
message ConnectionStateSync {
  uint32 flags = 1;                         // Current ConnectionStateFlags bitmask
  string state_name = 2;                    // Human-readable state (for debugging)
  string message = 3;                       // Optional status message
}

// ============================================================================
// Connection Messages
// ============================================================================

message ConnectRequest {
  // JWT is sent via WebSocket headers, not in protobuf
  int32 character_type = 1;         // Requested character type
}

message ConnectResponse {
  bytes user_id = 1;                // 16 bytes UUID
  string role = 2;                  // User role (admin, player, etc.)
  uint64 world_seed = 3;            // For deterministic terrain generation (legacy, use terrain_config)
  Vec3 spawn_position = 4;          // Server-assigned spawn position
  string username = 5;              // Player's username
  bool username_required = 6;       // True if user needs to register username
  uint32 connection_flags = 7;      // Current connection state flags
  PartyStateProto party_state = 8;  // Player's party (1 player + 2 companions)

  // Terrain configuration for deterministic world generation
  // Client uses this to pre-generate terrain chunks with identical results to server
  rentearth.terrain.WorldTerrainConfig terrain_config = 9;
}

// Client ready signal - replaces JSON ClientReady message
message ClientReady {
  uint32 client_flags = 1;          // Client's view of connection flags (for validation)
}

// ============================================================================
// Phase 2: Loading Scene Flow Messages
// ============================================================================

// Client -> Server: Request to enter game with specific character slot
// Sent from Loading Scene after user selects character
message EnterGameRequest {
  int32 character_slot = 1;         // 0-9 character slot
}

// ============================================================================
// Character Stats (8 core attributes - SOURCE OF TRUTH)
// ============================================================================
// DND-inspired: Min 8, Base 10, Soft cap 50, Hard cap 100
// Point system: 20 bonus at creation + 1/level (level 1 = 21 unspent)
// Players can lower stats from 10 to 8 during creation for extra points
//
// DERIVED STATS are computed from base attributes, not stored:
//   - HealthMax = (CON * 10) + FTH
//   - ManaMax = (INT * 8) + (WIS * 2)
//   - StaminaMax = (CON * 5) + (AGI * 3)
//   - AttackPower = STR * 2
//   - SpellPower = (INT * 2.5) + (WIS * 0.5)
//   - Defense = CON + (STR * 0.5)
//   - MagicResist = (WIS * 1.5) + (FTH * 0.5)
//   - Speed = 5.0 + (AGI * 0.05)
//   - CritChance = 5% + (AGI * 0.2%) + (LCK * 0.15%)
//   - CritDamage = 150% + (STR * 1%)
//   - etc.
//
// Equipment bonuses are applied on top of these calculations.
// ============================================================================
message CharacterStats {
  // =========================================================
  // Core Attributes (field numbers 1-8) - THE SOURCE OF TRUTH
  // Min 8, Base 10, Soft cap 50, Hard cap 100
  // =========================================================
  int32 strength = 1;           // STR: Melee damage, carry capacity
  int32 agility = 2;            // AGI: Speed, crit, attack speed
  int32 constitution = 3;       // CON: Health, stamina, defense
  int32 intelligence = 4;       // INT: Mana, spell damage
  int32 wisdom = 5;             // WIS: Mana regen, cooldowns
  int32 charisma = 6;           // CHA: Prices, party buffs
  int32 luck = 7;               // LCK: Drop rates, crit, rare spawns
  int32 faith = 8;              // FTH: Healing, holy damage, buffs

  // Skill points: 20 bonus at creation + 1/level (level 1 starts with 21)
  int32 unspent_skill_points = 9;

  // =========================================================
  // Current Resource Values (field numbers 10, 12, 14)
  // These can change during gameplay; max values are computed
  // =========================================================
  int32 health_current = 10;
  int32 mana_current = 12;
  int32 stamina_current = 14;

  // =========================================================
  // Progression (field numbers 33)
  // =========================================================
  int64 rested_xp = 33;           // Accumulated rested XP pool

  // =========================================================
  // COMPUTED VALUES (for network sync/display only)
  // Server recalculates these from base attributes + equipment
  // Client should also compute locally for validation
  // =========================================================
  int32 health_max = 11;          // Computed: (CON * 10) + FTH + equipment
  int32 mana_max = 13;            // Computed: (INT * 8) + (WIS * 2) + equipment
  int32 stamina_max = 15;         // Computed: (CON * 5) + (AGI * 3) + equipment
  int32 attack_power = 16;        // Computed: (STR * 2) + equipment
  int32 spell_power = 17;         // Computed: (INT * 2.5) + (WIS * 0.5) + equipment
  int32 defense = 18;             // Computed: CON + (STR * 0.5) + equipment
  int32 magic_resist = 19;        // Computed: (WIS * 1.5) + (FTH * 0.5) + equipment
  float speed = 20;               // Computed: 5.0 + (AGI * 0.05) + equipment%
  float crit_chance = 21;         // Computed: 5 + (AGI * 0.2) + (LCK * 0.15) + equipment
  float crit_damage = 22;         // Computed: 150 + STR + equipment
  float cooldown_reduction = 23;  // Computed: WIS * 0.5 + equipment
  float dodge_chance = 24;        // Computed: 2 + (AGI * 0.15) + (LCK * 0.1) + equipment
  int32 healing_power = 25;       // Computed: (FTH * 2) + (WIS * 0.5) + equipment
  int32 holy_damage = 26;         // Computed: FTH * 1.5 + equipment
  float buff_duration = 27;       // Computed: 100 + (CHA * 0.5) + equipment
  float debuff_resist = 28;       // Computed: 5 + (WIS * 0.3) + (FTH * 0.2) + equipment
  float loot_bonus = 29;          // Computed: LCK * 0.5 + equipment
  float rare_find = 30;           // Computed: LCK * 0.3 + equipment
  float crafting_quality = 31;    // Computed: (INT * 0.4) + (LCK * 0.1) + equipment
  int32 combat_rating = 32;       // Computed: (total_attributes - 80) * 2
}

// Server -> Client: Loading progress with character data
// Sent in response to EnterGameRequest
message LoadingProgress {
  // Character info
  bytes character_id = 1;           // 16 bytes UUID

  // House Naming System:
  //   - first_name: Character's given name (e.g., "Delta")
  //   - username: Player's account username (e.g., "Fudster")
  //   - display_name: Full display name "first_name of Haus username" (e.g., "Delta of Haus Fudster")
  string first_name = 2;            // Character's first name (was: character_name)
  string username = 25;             // Player's username from Supabase
  string display_name = 26;         // Constructed: "first_name of Haus username"

  string archetype = 3;             // e.g., "knight", "barbarian"
  int32 level = 4;
  int64 experience = 5;

  // Spawn position (from character_state or default)
  Vec3 spawn_position = 6;
  float spawn_rotation_yaw = 7;

  // Base64-encoded protobuf blobs (for client caching)
  bytes inventory_proto = 8;        // Serialized rentearthInventory
  int64 gold = 9;
  bytes state_proto = 10;           // Serialized rentearthCharacterState

  // Party state
  PartyStateProto party_state = 11;

  // Progress tracking (for loading bar)
  int32 total_steps = 12;           // Total loading steps
  int32 current_step = 13;          // Current step (0 = just started)
  string step_description = 14;     // e.g., "Loading character...", "Loading inventory..."

  // Character stats (8 core attributes + derived stats)
  CharacterStats stats = 27;        // Full stats from database
}

// Server -> Client: Confirms player spawn after ClientReady
// Signals Loading Scene to transition to Game Scene
message SpawnConfirmed {
  bytes entity_id = 1;              // Player's entity UUID in world
  Vec3 final_position = 2;          // Actual spawn position (may differ from requested)
  uint64 world_tick = 3;            // Current world tick for sync
}

// ============================================================================
// Character Management Messages (Character Select Screen)
// ============================================================================

// Client -> Server: Request list of characters for this user
message ListCharactersRequest {
  // Username is required for constructing display names
  // Client sends this to avoid server needing to look it up from DB
  string username = 1;
}

// Server -> Client: List of characters for character select
message ListCharactersResponse {
  repeated CharacterSummary characters = 1;
  string error = 2;                 // Set if operation failed
}

// Summary of a character (for character select screen)
message CharacterSummary {
  bytes id = 1;                     // Character UUID
  int32 slot = 2;                   // Character slot (0-9)
  string first_name = 3;            // Character's first name
  string display_name = 4;          // "first_name of Haus username"
  int32 visual_type = 5;            // VisualType enum
  int64 archetype_flags = 6;        // ArchetypeFlags bitfield
  int32 level = 7;
  int64 experience = 8;
  int64 gold = 9;
  string current_zone = 10;         // Last known zone
  int32 health_current = 11;
  int32 health_max = 12;
  int64 last_login_at = 13;         // Unix timestamp (seconds)
  int64 total_playtime = 14;        // Seconds played
  string created_at = 15;           // ISO timestamp
}

// Client -> Server: Request to create a new character
message CreateCharacterRequest {
  int32 slot = 1;                   // Target slot (0-9)
  string first_name = 2;            // Character's first name
  string archetype_slug = 3;        // e.g., "warrior", "mage"
  int32 visual_type = 4;            // VisualType enum
  float spawn_x = 5;                // Optional spawn position
  float spawn_y = 6;
  float spawn_z = 7;
}

// Server -> Client: Result of character creation
message CreateCharacterResponse {
  bool success = 1;
  CharacterSummary character = 2;   // Created character (if success)
  string error = 3;                 // Error message (if failed)
}

// Client -> Server: Request to delete a character
message DeleteCharacterRequest {
  int32 slot = 1;                   // Slot to delete (0-9)
}

// Server -> Client: Result of character deletion
message DeleteCharacterResponse {
  bool success = 1;
  int32 deleted_slot = 2;           // Which slot was deleted
  string error = 3;                 // Error message (if failed)
}

// Client -> Server: Request list of available archetypes
message ListArchetypesRequest {
  // Empty - returns all active archetypes
}

// Server -> Client: List of available archetypes for character creation
message ListArchetypesResponse {
  repeated ArchetypeInfo archetypes = 1;
  string error = 2;
}

// Archetype information for character creation
message ArchetypeInfo {
  bytes id = 1;                     // Archetype UUID
  string slug = 2;                  // e.g., "warrior", "mage"
  string description = 3;           // Display description
  int64 archetype_flags = 4;        // ArchetypeFlags bitfield
  int64 unlock_flags = 5;           // Required unlocks
  repeated string companion_slugs = 6;  // Default companions
  int32 sort_order = 7;
  bytes base_stats = 8;             // Serialized base stats proto
  bytes stat_growth = 9;            // Serialized stat growth proto
  string prefab_local = 10;         // Unity prefab path (local)
  string prefab_network = 11;       // Unity prefab path (network)
  string icon_reference = 12;       // UI icon reference
}

// Client -> Server: Save character appearance
message SaveAppearanceRequest {
  bytes character_id = 1;           // Character UUID
  CharacterAppearance appearance = 2;
}

// Server -> Client: Result of appearance save
message SaveAppearanceResponse {
  bool success = 1;
  string error = 2;                 // Error message (if failed)
}

// ============================================================================
// Environment Objects
// ============================================================================

enum EnvironmentObjectType {
  ENVIRONMENT_OBJECT_TYPE_TREE = 0;
  ENVIRONMENT_OBJECT_TYPE_ROCK = 1;
  ENVIRONMENT_OBJECT_TYPE_BUSH = 2;
  ENVIRONMENT_OBJECT_TYPE_GRASS = 3;
}

enum ResourceType {
  RESOURCE_TYPE_WOOD = 0;
  RESOURCE_TYPE_STONE = 1;
  RESOURCE_TYPE_BERRIES = 2;
  RESOURCE_TYPE_HERBS = 3;
  RESOURCE_TYPE_NONE = 4;
}

message EnvironmentObject {
  uint64 object_id = 1;
  Vec3 position = 2;
  Quat rotation = 3;
  Vec3 scale = 4;
  int32 object_type = 5;            // EnvironmentObjectType
  uint32 variant = 6;               // Visual variant
  int32 resource_type = 7;          // ResourceType
  uint32 resource_amount = 8;
  float harvest_time = 9;
}

message EnvironmentBatch {
  repeated EnvironmentObject objects = 1;
  repeated uint64 removed_object_ids = 2;
}

// ============================================================================
// Harvest System
// ============================================================================

message HarvestAction {
  oneof action {
    StartHarvest start = 1;
    UpdateHarvest update = 2;
    CompleteHarvest complete = 3;
    CancelHarvest cancel = 4;
  }
}

message StartHarvest {
  uint64 object_id = 1;
  Vec3 player_position = 2;
}

message UpdateHarvest {
  Vec3 player_position = 1;
}

message CompleteHarvest {
  // Empty - just signals completion
}

message CancelHarvest {
  // Empty - just signals cancellation
}

message HarvestResource {
  string resource_type = 1;         // e.g., "wood", "stone"
  uint32 amount = 2;
}

message HarvestUpdate {
  uint64 object_id = 1;
  float progress = 2;               // 0.0 to 1.0
  string status = 3;                // "started", "in_progress", "complete", "canceled"
  string message = 4;               // Optional message
  repeated HarvestResource resources = 5;   // Harvested resources (on complete)
  float harvest_duration = 6;       // Total duration (on start)
}

// ============================================================================
// Item System Enums
// ============================================================================

enum ItemCategory {
  CATEGORY_EQUIPMENT = 0;
  CATEGORY_CONSUMABLE = 1;
  CATEGORY_MATERIAL = 2;
  CATEGORY_QUEST = 3;
  CATEGORY_CURRENCY = 4;
  CATEGORY_KEY = 5;
  CATEGORY_TOOL = 6;
  CATEGORY_GEM = 7;
  CATEGORY_ENCHANT = 8;
}

enum ItemRarity {
  RARITY_COMMON = 0;      // White - base stats
  RARITY_UNCOMMON = 1;    // Green - +10% stats
  RARITY_RARE = 2;        // Blue - +25% stats, 1 socket
  RARITY_EPIC = 3;        // Purple - +50% stats, 2 sockets
  RARITY_LEGENDARY = 4;   // Orange - +100% stats, 3 sockets
}

enum BindType {
  BIND_NONE = 0;           // Can trade freely
  BIND_ON_PICKUP = 1;      // Bound when looted
  BIND_ON_EQUIP = 2;       // Bound when first equipped
  BIND_SOULBOUND = 3;      // Always bound
}

enum StatType {
  STAT_NONE = 0;
  STAT_ATTACK = 1;
  STAT_DEFENSE = 2;
  STAT_HEALTH = 3;
  STAT_MANA = 4;
  STAT_SPEED = 5;
  STAT_CRIT_CHANCE = 6;
  STAT_CRIT_DAMAGE = 7;
}

enum EquipmentSlot {
  // Visual slots (rendered in Unity)
  SLOT_HEAD = 0;
  SLOT_CHEST = 1;
  SLOT_HANDS = 2;
  SLOT_LEGS = 3;
  SLOT_FEET = 4;
  SLOT_WEAPON = 5;

  // Non-visual slots (stats only)
  SLOT_OFFHAND = 6;
  SLOT_RING_1 = 7;
  SLOT_RING_2 = 8;
  SLOT_NECKLACE = 9;
  SLOT_BACK = 10;

  // Hotbar quick slots
  SLOT_QUICK_1 = 11;
  SLOT_QUICK_2 = 12;
  SLOT_QUICK_3 = 13;
  SLOT_QUICK_4 = 14;
}

// ============================================================================
// Item Instance (single item in the world)
// ============================================================================

message StatBonus {
  StatType stat_type = 1;
  int32 value = 2;
}

// Represents a single item instance (from items table)
message ItemInstance {
  bytes id = 1;                       // UUID (16 bytes)
  string item_slug = 2;               // Reference to item_definitions

  // Stack
  uint32 quantity = 3;

  // Durability (-1 if no durability)
  int32 durability_current = 4;
  int32 durability_max = 5;

  // Rarity & enhancement
  ItemRarity rarity = 6;
  int32 enhancement_level = 7;        // +0 to +15

  // Random bonus stats (rolled on creation)
  StatBonus bonus_1 = 8;
  StatBonus bonus_2 = 9;
  StatBonus bonus_3 = 10;

  // Sockets (UUIDs of socketed gems)
  repeated bytes socket_gems = 11;

  // Binding
  BindType bind_type = 12;
  bool is_bound = 13;

  // Location
  string container_type = 14;         // 'inventory', 'equipment', 'bank', 'auction'
  int32 container_slot = 15;
}

// ============================================================================
// Inventory System (UUID array model)
// ============================================================================

// Full inventory state sent to client on login
message CharacterInventoryState {
  // Slot array (index = slot position, empty bytes = empty slot)
  repeated bytes slots = 1;           // 40-100 UUIDs

  // Full item data for items in inventory
  repeated ItemInstance items = 2;

  // Currency
  int64 gold = 3;

  // Size
  uint32 max_slots = 4;

  // Revision for sync
  int64 revision = 5;
}

// Delta update after inventory changes
message InventoryDelta {
  repeated SlotChange changes = 1;
  int64 gold = 2;
  int64 new_revision = 3;
  repeated ItemInstance updated_items = 4;  // Full data for new/changed items
}

message SlotChange {
  int32 slot = 1;
  bytes item_id = 2;                  // Empty = slot cleared
}

// Inventory actions from client
message InventoryAction {
  oneof action {
    MoveItemRequest move = 1;
    SplitStackRequest split = 2;
    MergeStackRequest merge = 3;
    DropItemRequest drop = 4;
    UseItemRequest use = 5;
    DestroyItemRequest destroy = 6;
  }
}

message MoveItemRequest {
  int32 from_slot = 1;
  int32 to_slot = 2;
}

message SplitStackRequest {
  int32 slot = 1;
  uint32 amount = 2;
  int32 target_slot = 3;              // -1 = first empty
}

message MergeStackRequest {
  int32 from_slot = 1;
  int32 to_slot = 2;
}

message DropItemRequest {
  int32 slot = 1;
  uint32 quantity = 2;                // For stacks
}

message UseItemRequest {
  int32 slot = 1;
  bytes target_entity_id = 2;         // Optional target
}

message DestroyItemRequest {
  int32 slot = 1;
  uint32 quantity = 2;
}

message InventoryUpdate {
  bytes user_id = 1;
  bool success = 2;
  string error = 3;
  InventoryDelta delta = 4;
}

// ============================================================================
// Equipment System
// ============================================================================

// Full equipment state sent to client
message CharacterEquipmentState {
  // Equipment slot -> item UUID (empty bytes = nothing equipped)
  map<int32, bytes> equipped_items = 1;  // Key = EquipmentSlot enum

  // Full item data for equipped items
  repeated ItemInstance items = 2;

  // Hotbar bindings (slot -> inventory item UUID)
  map<int32, bytes> hotbar = 3;          // Key = SLOT_QUICK_1-4

  // Cached total stats
  int32 total_attack = 4;
  int32 total_defense = 5;
  int32 total_health_bonus = 6;
  int32 total_mana_bonus = 7;
  int32 total_speed_bonus = 8;
  int32 gear_score = 9;
}

// Minimal visual data sent to other players
message VisualEquipment {
  string head_visual = 1;
  string chest_visual = 2;
  string hands_visual = 3;
  string legs_visual = 4;
  string feet_visual = 5;
  string weapon_visual = 6;

  // Color/material variants (for dyes)
  int32 head_variant = 7;
  int32 chest_variant = 8;
  int32 hands_variant = 9;
  int32 legs_variant = 10;
  int32 feet_variant = 11;
  int32 weapon_variant = 12;
}

message EquipmentAction {
  oneof action {
    EquipItemRequest equip = 1;
    UnequipItemRequest unequip = 2;
    SwapEquipmentRequest swap = 3;
    SetHotbarRequest set_hotbar = 4;
    UseHotbarRequest use_hotbar = 5;
  }
}

message EquipItemRequest {
  int32 inventory_slot = 1;
  EquipmentSlot target_slot = 2;
}

message UnequipItemRequest {
  EquipmentSlot slot = 1;
  int32 target_inventory_slot = 2;    // -1 = first empty
}

message SwapEquipmentRequest {
  EquipmentSlot slot_a = 1;
  EquipmentSlot slot_b = 2;
}

message SetHotbarRequest {
  int32 hotbar_slot = 1;              // 0-3
  int32 inventory_slot = 2;           // -1 to clear
}

message UseHotbarRequest {
  int32 hotbar_slot = 1;
  bytes target_entity_id = 2;
}

message EquipmentUpdateResponse {
  bool success = 1;
  string error = 2;
  CharacterEquipmentState equipment = 3;
  VisualEquipment visuals = 4;
  InventoryDelta inventory_delta = 5;
}

// ============================================================================
// Bank System
// ============================================================================

message CharacterBankState {
  repeated BankTab tabs = 1;
  uint32 tabs_unlocked = 2;
  int64 stored_gold = 3;
  repeated ItemInstance items = 4;    // Full item data
}

message BankTab {
  uint32 tab_index = 1;               // 0-4
  repeated bytes slots = 2;           // 28 UUIDs
  bool is_locked = 3;
}

message BankAction {
  oneof action {
    OpenBankRequest open = 1;
    DepositItemRequest deposit = 2;
    WithdrawItemRequest withdraw = 3;
    MoveBankItemRequest move_bank = 4;
    DepositGoldRequest deposit_gold = 5;
    WithdrawGoldRequest withdraw_gold = 6;
    UnlockTabRequest unlock_tab = 7;
  }
}

message OpenBankRequest {
  bytes npc_entity_id = 1;
}

message DepositItemRequest {
  int32 inventory_slot = 1;
  int32 bank_tab = 2;
  int32 bank_slot = 3;                // -1 = first empty
  uint32 quantity = 4;                // 0 = all
}

message WithdrawItemRequest {
  int32 bank_tab = 1;
  int32 bank_slot = 2;
  int32 inventory_slot = 3;           // -1 = first empty
  uint32 quantity = 4;
}

message MoveBankItemRequest {
  int32 from_tab = 1;
  int32 from_slot = 2;
  int32 to_tab = 3;
  int32 to_slot = 4;
}

message DepositGoldRequest {
  int64 amount = 1;                   // 0 = all
}

message WithdrawGoldRequest {
  int64 amount = 1;
}

message UnlockTabRequest {
  // Cost determined by server
}

message BankResponse {
  bool success = 1;
  string error = 2;
  oneof result {
    CharacterBankState bank_state = 3;
    BankDelta delta = 4;
  }
}

message BankDelta {
  int32 tab = 1;
  repeated SlotChange changes = 2;
  int64 stored_gold = 3;
  int64 inventory_gold = 4;
}

// ============================================================================
// Character Appearance System
// ============================================================================

message CharacterAppearance {
  // Body
  int32 skin_color = 1;               // 0-15 palette index
  int32 body_type = 2;                // 0-4
  int32 body_height = 3;              // 0-100

  // Face
  int32 face_shape = 4;               // 0-7
  int32 eye_color = 5;                // 0-15
  int32 eye_shape = 6;                // 0-7
  int32 eyebrow_style = 7;            // 0-7
  int32 eyebrow_color = 8;            // 0-15
  int32 nose_style = 9;               // 0-7
  int32 mouth_style = 10;             // 0-7

  // Hair
  int32 hair_style = 11;              // 0-31
  int32 hair_color = 12;              // 0-15

  // Facial hair
  int32 facial_hair_style = 13;       // 0-15 (0=none)
  int32 facial_hair_color = 14;       // 0-15

  // Extras
  int32 scar_style = 15;              // 0-7 (0=none)
  int32 tattoo_style = 16;            // 0-15 (0=none)
  int32 tattoo_color = 17;            // 0-15

  // Accessories
  int32 accessory_1 = 18;
  int32 accessory_2 = 19;

  // Voice
  int32 voice_type = 20;              // 0-7
}

// Compact version for network sync to other players
message CompactAppearance {
  uint32 body_data = 1;               // skin(4) + body_type(3) + height(7) = 14 bits
  uint32 face_data = 2;               // face + eyes + brows + nose + mouth = 19 bits
  uint32 hair_data = 3;               // hair + facial hair = 17 bits
  uint32 extra_data = 4;              // scar + tattoo + accessories + voice = 22 bits
}

message BarberAction {
  oneof action {
    OpenBarberRequest open = 1;
    PreviewChangeRequest preview = 2;
    ApplyChangesRequest apply = 3;
  }
}

message OpenBarberRequest {
  bytes npc_entity_id = 1;
}

message PreviewChangeRequest {
  CharacterAppearance preview = 1;
}

message ApplyChangesRequest {
  CharacterAppearance changes = 1;    // Only changeable fields
}

message BarberResponse {
  bool success = 1;
  string error = 2;
  int64 gold_cost = 3;
  CharacterAppearance appearance = 4;
}

// ============================================================================
// Health System (client -> server)
// ============================================================================

message HealthAction {
  oneof action {
    UpdateHealthRequest update_health = 1;
    GetHealthRequest get_health = 2;
  }
}

message UpdateHealthRequest {
  float health_delta = 1;           // Positive for heal, negative for damage
  string source = 2;                // What caused the health change (for logging)
}

message GetHealthRequest {
  // Empty - requests current health
}

// ============================================================================
// Session Management
// ============================================================================

message LeaveGame {
  // Empty - signals player is leaving gracefully
  // Server will broadcast PlayerLeft to nearby players
}

message GetGameState {
  // Empty - requests current game state (nearby players, objects, etc.)
  // Useful for reconnection scenarios
}

// ============================================================================
// Player Events (broadcast to nearby players)
// ============================================================================

message PlayerJoined {
  bytes user_id = 1;

  // House Naming System:
  //   - first_name: Character's given name (e.g., "Delta")
  //   - username: Player's account username (e.g., "Fudster")
  //   - display_name: Full display name "first_name of Haus username" (e.g., "Delta of Haus Fudster")
  string first_name = 14;             // Character's first name
  string username = 2;                // Player's username from Supabase (kept at field 2 for compatibility)
  string display_name = 15;           // Constructed: "first_name of Haus username"

  Vec3 position = 3;
  Quat rotation = 4;

  // Entity model fields
  int32 character_type = 5;           // CharacterType enum (PLAYER, NPC, MONSTER, etc.)
  int32 visual_type = 6;              // VisualType enum (HUMAN_MALE, SKELETON, etc.)
  int64 behavior_flags = 7;           // BehaviorFlags bitfield
  int64 emotional_flags = 8;          // EmotionalFlags bitfield
  int64 archetype_flags = 9;          // ArchetypeFlags bitfield
  int32 animation_state = 10;         // AnimationState enum (base locomotion)
  int32 animation_flags = 11;         // AnimationFlag bitfield (visual modifiers)
  int32 combat_state = 12;            // CombatState enum (attacking, blocking, etc.)
  int32 combat_flags = 13;            // CombatFlag bitfield (in_combat, combo, etc.)
}

message PlayerLeft {
  bytes user_id = 1;
}

message PlayerMoved {
  bytes user_id = 1;
  Vec3 position = 2;
  Quat rotation = 3;
  int32 animation_state = 4;          // AnimationState enum (base locomotion)
  int32 animation_flags = 7;          // AnimationFlag bitfield (visual modifiers)
  int32 combat_state = 8;             // CombatState enum (attacking, blocking, etc.)
  int32 combat_flags = 9;             // CombatFlag bitfield (in_combat, combo, etc.)
  int32 visual_type = 5;              // VisualType enum (which model is rendering)
  int64 emotional_flags = 6;          // Emotions can change during movement
}

message PlayerHealthChanged {
  bytes user_id = 1;
  float health = 2;
  float max_health = 3;
  bool is_alive = 4;
}

// ============================================================================
// Username Registration
// ============================================================================

message SetUsername {
  string username = 1;
}

message UsernameResult {
  bytes user_id = 1;
  string username = 2;              // Set on success
  string error = 3;                 // Set on failure
  string error_code = 4;            // Optional error code
}

// ============================================================================
// Terrain System
// ============================================================================

message TerrainChunkRequest {
  int32 chunk_x = 1;
  int32 chunk_z = 2;
}

message TerrainChunk {
  int32 chunk_x = 1;
  int32 chunk_z = 2;
  float chunk_size = 3;             // World units (e.g., 500)
  uint32 resolution = 4;            // Grid resolution (e.g., 31x31)
  repeated float heights = 5;       // Row-major height values
}

// ============================================================================
// Debug Object Query System (MSCP)
// ============================================================================

// Client request to query object details by ID
message DebugObjectQuery {
  uint64 object_id = 1;
}

// Server response with full object details
message DebugObjectInfo {
  uint64 object_id = 1;
  string asset_name = 2;
  int32 object_type = 3;              // EnvironmentObjectType enum
  Vec3 position = 4;
  Quat rotation = 5;
  Vec3 scale = 6;
  int32 resource_type = 7;            // ResourceType enum
  uint32 resource_amount = 8;
  float harvest_time = 9;
  bool is_harvested = 10;
  int64 harvested_at_ms = 11;         // Unix timestamp when harvested
  float respawn_time_seconds = 12;
  bool found = 13;                    // False if object not found
  string error = 14;                  // Error message if not found
}

// ============================================================================
// Party System
// ============================================================================

// A single party member (player or companion NPC)
message PartyMemberProto {
  bytes entity_id = 1;              // 16-byte UUID

  // House Naming System:
  //   - first_name: Character's given name (e.g., "Delta")
  //   - username: Player's account username (e.g., "Fudster")
  //   - display_name: Full display name "first_name of Haus username" (e.g., "Delta of Haus Fudster")
  //                   For companions: "first_name (Companion of Haus username)"
  string first_name = 8;            // Character's first name
  string username = 9;              // Player's username from Supabase
  string display_name = 2;          // Constructed display name (kept at field 2 for compatibility)

  bool is_player = 3;               // True for member 0 (the player)
  bool is_active = 4;               // True for currently controlled member

  // New entity model fields
  int32 character_type = 5;         // CharacterType enum (PLAYER, COMPANION, etc.)
  int32 visual_type = 6;            // VisualType enum (HUMAN_MALE, etc.)
  int64 archetype_flags = 7;        // ArchetypeFlags bitfield
}

// Full party state (sent on connect and after switches)
message PartyStateProto {
  bytes owner_id = 1;               // Player UUID who owns this party
  repeated PartyMemberProto members = 2;  // Always 3 members
  uint32 active_member_index = 3;   // 0, 1, or 2
}

// Client -> Server: Request to switch active party member
message SwitchPartyMemberRequest {
  uint32 target_index = 1;          // 0, 1, or 2
}

// Server -> Client: Result of switch request
message SwitchPartyMemberResponse {
  bool success = 1;
  uint32 new_active_index = 2;      // Actual active index after request
  string error = 3;                 // Error message if success=false
}

// Server -> All nearby clients: Broadcast when any player's party switches
message PartyUpdateBroadcast {
  bytes owner_id = 1;               // Which player's party changed
  uint32 active_member_index = 2;   // New active member index
}

// ============================================================================
// Misc Messages
// ============================================================================

message Ping {
  int64 client_time_ms = 1;
}

message Pong {
  int64 server_time_ms = 1;
  int64 client_time_ms = 2;         // Echo back for RTT calculation
}

message Error {
  string message = 1;
  string code = 2;                  // Optional error code
}

// ============================================================================
// Wrapper Messages (for WebSocket binary frames)
// ============================================================================

// Server -> Client wrapper
message ServerMessage {
  oneof payload {
    // Snapshot system (new)
    WorldSnapshot world_snapshot = 1;

    // Connection
    ConnectResponse connect_response = 2;
    ConnectionStateSync connection_state = 14;  // State sync on every transition

    // Environment
    EnvironmentBatch environment_batch = 3;

    // Harvest
    HarvestUpdate harvest_update = 4;

    // Player events (legacy - will be replaced by snapshots)
    PlayerJoined player_joined = 5;
    PlayerLeft player_left = 6;
    PlayerMoved player_moved = 7;
    PlayerHealthChanged player_health_changed = 8;

    // Inventory
    InventoryUpdate inventory_update = 9;

    // Username
    UsernameResult username_result = 10;

    // Terrain
    TerrainChunk terrain_chunk = 11;

    // Misc
    Pong pong = 12;
    Error error = 13;

    // Debug
    DebugObjectInfo debug_object_info = 15;

    // Party system
    PartyStateProto party_state = 16;
    SwitchPartyMemberResponse switch_party_result = 17;
    PartyUpdateBroadcast party_update = 18;

    // Phase 2: Loading Scene
    LoadingProgress loading_progress = 19;
    SpawnConfirmed spawn_confirmed = 20;

    // Terrain modifications (sent when player enters chunks with modifications)
    rentearth.terrain.ChunkModificationsResponse chunk_modifications = 21;
    rentearth.terrain.TerraformResponse terraform_response = 22;

    // Character management (Character Select Screen)
    ListCharactersResponse list_characters_response = 23;
    CreateCharacterResponse create_character_response = 24;
    DeleteCharacterResponse delete_character_response = 25;
    ListArchetypesResponse list_archetypes_response = 26;
    SaveAppearanceResponse save_appearance_response = 27;
  }
}

// Client -> Server wrapper
message ClientMessage {
  oneof payload {
    // Snapshot system (new)
    PlayerInput player_input = 1;

    // Connection
    ConnectRequest connect_request = 2;
    ClientReady client_ready = 7;     // Replaces LegacyClientReady

    // Harvest
    HarvestAction harvest_action = 3;

    // Username
    SetUsername set_username = 4;

    // Terrain
    TerrainChunkRequest terrain_chunk_request = 5;

    // Misc
    Ping ping = 6;

    // Inventory
    InventoryAction inventory_action = 8;

    // Health/Combat
    HealthAction health_action = 9;

    // Session
    LeaveGame leave_game = 10;
    GetGameState get_game_state = 11;

    // Debug
    DebugObjectQuery debug_object_query = 12;

    // Party system
    SwitchPartyMemberRequest switch_party_member = 13;

    // Phase 2: Loading Scene
    EnterGameRequest enter_game_request = 14;

    // Terrain system
    rentearth.terrain.ChunkModificationsRequest chunk_modifications_request = 15;
    rentearth.terrain.TerraformRequest terraform_request = 16;

    // Character management (Character Select Screen)
    ListCharactersRequest list_characters_request = 17;
    CreateCharacterRequest create_character_request = 18;
    DeleteCharacterRequest delete_character_request = 19;
    ListArchetypesRequest list_archetypes_request = 20;
    SaveAppearanceRequest save_appearance_request = 21;
  }
}
