syntax = "proto3";

package rentearth.schema;

import "rentearth/sql_options.proto";

// =============================================================================
// Rent Earth Database Schema Definition
// =============================================================================
// This file defines the mapping between proto messages and PostgreSQL tables.
// Run proto_to_sql.py to generate SQL DDL from this definition.
//
// Source of Truth:
//   - Proto messages define the data structures
//   - This file defines how they map to SQL
//   - Generated SQL goes to proto/schema/generated/
//   - Manual SQL (policies, RPCs) stays in proto/schema/rentearth.sql
// =============================================================================

message RentEarthSchema {
  rentearth.sql.SqlSchema schema = 1;
}

// =============================================================================
// Schema Definition
// =============================================================================

// This is parsed by proto_to_sql.py to generate tables
// The actual data is below as a "template" in comments that the script reads

/*
@sql.schema: rentearth
@sql.owner: postgres

# =============================================================================
# CHARACTER TABLES
# =============================================================================

@sql.table: character
@sql.source: manual
@sql.description: Per-player characters with House naming. Display: "first_name of Haus username".
@sql.columns:
  - id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
  - user_id: uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE
  - slot: smallint NOT NULL CHECK (slot BETWEEN 0 AND 9)
  - first_name: text NOT NULL  # Character's given name (e.g., "Delta")
  - archetype: text NOT NULL
  - level: integer NOT NULL DEFAULT 1 CHECK (level >= 1)
  - experience: bigint NOT NULL DEFAULT 0 CHECK (experience >= 0)
  - created_at: timestamptz NOT NULL DEFAULT timezone('utc', now())
  - updated_at: timestamptz NOT NULL DEFAULT timezone('utc', now())
@sql.constraints:
  - UNIQUE (user_id, slot)
  - CHECK (first_name = btrim(first_name))
  - CHECK (char_length(first_name) BETWEEN 1 AND 32)
@sql.indexes:
  - idx_character_user_id: (user_id)

# -----------------------------------------------------------------------------
# character_stats - HOT table from rentearth.snapshot.BugWarsCharacterState
# -----------------------------------------------------------------------------

@sql.table: character_stats
@sql.type: HOT
@sql.source: rentearth.snapshot.BugWarsCharacterState
@sql.description: HOT table: Queryable character stats including position (x, y, z). Synced from Axum.
@sql.columns:
  # Primary key (foreign key to character)
  - character_id: uuid PRIMARY KEY REFERENCES rentearth.character(id) ON DELETE CASCADE

  # From BugWarsCharacterState.position (Vec3)
  - world_x: real NOT NULL DEFAULT 0  # @proto: position.x
  - world_y: real NOT NULL DEFAULT 0  # @proto: position.y
  - world_z: real NOT NULL DEFAULT 0  # @proto: position.z

  # From BugWarsCharacterState.rotation_yaw
  - rotation_yaw: real NOT NULL DEFAULT 0  # @proto: rotation_yaw

  # Safe position for respawn (not in proto - db-only)
  - last_safe_x: real NOT NULL DEFAULT 0
  - last_safe_y: real NOT NULL DEFAULT 0
  - last_safe_z: real NOT NULL DEFAULT 0

  # From BugWarsCharacterState health/mana/energy
  - health_current: integer NOT NULL DEFAULT 100  # @proto: health_current (cast float->int)
  - health_max: integer NOT NULL DEFAULT 100      # @proto: health_max
  - mana_current: integer NOT NULL DEFAULT 100    # @proto: mana_current
  - mana_max: integer NOT NULL DEFAULT 100        # @proto: mana_max
  - stamina_current: integer NOT NULL DEFAULT 100 # @proto: energy_current (renamed)
  - stamina_max: integer NOT NULL DEFAULT 100     # @proto: energy_max

  # Combat stats (derived, not in proto)
  - attack_power: integer NOT NULL DEFAULT 10
  - defense: integer NOT NULL DEFAULT 10
  - speed: real NOT NULL DEFAULT 5.0

  # From BugWarsCharacterState.current_zone_id (mapped to text)
  - current_zone: text NOT NULL DEFAULT 'starting_area'  # @proto: current_zone_id (lookup)

  # Session tracking (not in proto - db-only)
  - last_login_at: timestamptz
  - total_playtime: interval NOT NULL DEFAULT '0 seconds'  # @proto: play_time_seconds

  - updated_at: timestamptz NOT NULL DEFAULT timezone('utc', now())

@sql.indexes:
  - idx_character_stats_zone: (current_zone)
  - idx_character_stats_position: (world_x, world_z)

# -----------------------------------------------------------------------------
# character_state - COLD table (protobuf blob)
# -----------------------------------------------------------------------------

@sql.table: character_state
@sql.type: COLD
@sql.source: rentearth.snapshot.BugWarsCharacterState
@sql.description: COLD table: Opaque runtime state serialized as protobuf.
@sql.columns:
  - character_id: uuid PRIMARY KEY REFERENCES rentearth.character(id) ON DELETE CASCADE
  - state_proto: bytea NOT NULL DEFAULT '\x'::bytea  # Full BugWarsCharacterState
  - session_revision: bigint NOT NULL DEFAULT 0
  - updated_at: timestamptz NOT NULL DEFAULT timezone('utc', now())

# -----------------------------------------------------------------------------
# inventory - COLD table from rentearth.snapshot.Inventory
# -----------------------------------------------------------------------------

@sql.table: inventory
@sql.type: COLD
@sql.source: rentearth.snapshot.Inventory
@sql.description: Authoritative per-character inventory payload stored as protobuf.
@sql.columns:
  - character_id: uuid PRIMARY KEY REFERENCES rentearth.character(id) ON DELETE CASCADE
  - items_proto: bytea NOT NULL DEFAULT '\x'::bytea  # Full Inventory proto
  - gold: bigint NOT NULL DEFAULT 0 CHECK (gold >= 0)
  - last_revision: bigint NOT NULL DEFAULT 0
  - updated_at: timestamptz NOT NULL DEFAULT timezone('utc', now())

# =============================================================================
# ARCHETYPE TABLES
# =============================================================================

@sql.table: archetypes
@sql.type: HOT
@sql.source: manual
@sql.description: Character class definitions (HOT table).
@sql.columns:
  - id: uuid PRIMARY KEY DEFAULT gen_random_uuid()
  - slug: text NOT NULL UNIQUE
  - description: text NOT NULL DEFAULT ''
  - archetype_flags: bigint NOT NULL DEFAULT 0
  - unlock_flags: bigint NOT NULL DEFAULT 0
  - companion_slugs: text[] NOT NULL DEFAULT '{}'
  - sort_order: smallint NOT NULL DEFAULT 0
  - is_active: bool NOT NULL DEFAULT true
  - version: int NOT NULL DEFAULT 1
  - created_at: timestamptz NOT NULL DEFAULT timezone('utc', now())
  - updated_at: timestamptz NOT NULL DEFAULT timezone('utc', now())
@sql.constraints:
  - CHECK (slug = btrim(slug) AND slug ~ '^[a-z][a-z0-9_]*$')
  - CHECK (char_length(slug) BETWEEN 1 AND 32)
@sql.indexes:
  - idx_archetypes_slug: (slug)
  - idx_archetypes_active: (is_active) WHERE is_active = true

@sql.table: archetype_states
@sql.type: COLD
@sql.source: manual
@sql.description: Archetype ECS data (COLD table). Stats and Unity asset references.
@sql.columns:
  - archetype_id: uuid PRIMARY KEY REFERENCES rentearth.archetypes(id) ON DELETE CASCADE
  - base_stats: bytea NOT NULL DEFAULT '\x'::bytea
  - stat_growth: bytea NOT NULL DEFAULT '\x'::bytea
  - prefab_local: text NOT NULL DEFAULT ''
  - prefab_network: text NOT NULL DEFAULT ''
  - icon_reference: text NOT NULL DEFAULT ''
  - updated_at: timestamptz NOT NULL DEFAULT timezone('utc', now())

# =============================================================================
# PROGRESSION TABLES
# =============================================================================

@sql.table: character_progress
@sql.type: HOT
@sql.source: rentearth.snapshot.BugWarsCharacterState
@sql.description: HOT table: Queryable progression flags and reputation.
@sql.columns:
  - character_id: uuid PRIMARY KEY REFERENCES rentearth.character(id) ON DELETE CASCADE
  - story_flags: bigint NOT NULL DEFAULT 0       # @proto: quest_flags
  - dialogue_flags: bigint NOT NULL DEFAULT 0
  - tutorial_flags: bigint NOT NULL DEFAULT 0
  - achievement_flags: bigint NOT NULL DEFAULT 0 # @proto: achievement_flags
  - rep_farmers: smallint NOT NULL DEFAULT 0
  - rep_merchants: smallint NOT NULL DEFAULT 0
  - rep_explorers: smallint NOT NULL DEFAULT 0
  - rep_craftsmen: smallint NOT NULL DEFAULT 0
  - updated_at: timestamptz NOT NULL DEFAULT timezone('utc', now())

@sql.table: character_progress_state
@sql.type: COLD
@sql.source: manual
@sql.description: COLD table: Serialized protobuf blobs for detailed progression.
@sql.columns:
  - character_id: uuid PRIMARY KEY REFERENCES rentearth.character(id) ON DELETE CASCADE
  - dialogue_history: bytea NOT NULL DEFAULT '\x'::bytea
  - reputation_data: bytea NOT NULL DEFAULT '\x'::bytea
  - quest_state: bytea NOT NULL DEFAULT '\x'::bytea
  - npc_storylines: bytea NOT NULL DEFAULT '\x'::bytea
  - updated_at: timestamptz NOT NULL DEFAULT timezone('utc', now())

*/
