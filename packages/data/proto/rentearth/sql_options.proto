syntax = "proto3";

package rentearth.sql;

// =============================================================================
// SQL Schema Generation Options
// =============================================================================
// These messages define how proto messages map to PostgreSQL tables.
// The proto_to_sql.py script reads these to generate SQL DDL.
//
// Usage in other protos:
//   import "rentearth/sql_options.proto";
//
// Then annotate messages with comments like:
//   // @sql.table: rentearth.character_stats
//   // @sql.type: HOT
//   message CharacterStats { ... }
//
// Or use the SqlTableDef message for explicit mapping:
//   message SqlSchema {
//     repeated SqlTableDef tables = 1;
//   }
// =============================================================================

// Defines how a proto message maps to a SQL table
message SqlTableDef {
  string proto_message = 1;        // e.g., "rentearth.snapshot.BugWarsCharacterState"
  string sql_schema = 2;           // e.g., "rentearth"
  string sql_table = 3;            // e.g., "character_stats"
  TableType table_type = 4;        // HOT (columns) or COLD (bytea blob)
  repeated SqlColumnDef columns = 5;
  repeated string primary_key = 6; // Column names for PRIMARY KEY
  repeated SqlForeignKey foreign_keys = 7;
  repeated SqlIndex indexes = 8;
}

enum TableType {
  TABLE_TYPE_UNSPECIFIED = 0;
  TABLE_TYPE_HOT = 1;              // Queryable columns
  TABLE_TYPE_COLD = 2;             // Store as bytea blob
}

// Defines how a proto field maps to a SQL column
message SqlColumnDef {
  string proto_field = 1;          // e.g., "position.x" (dot notation for nested)
  string sql_column = 2;           // e.g., "world_x"
  string sql_type = 3;             // e.g., "real", "integer", "text", "bytea"
  bool not_null = 4;               // DEFAULT true
  string default_value = 5;        // SQL default expression
  string check_constraint = 6;     // SQL CHECK constraint
  string comment = 7;              // Column comment
}

// Foreign key definition
message SqlForeignKey {
  repeated string columns = 1;     // Local column(s)
  string ref_schema = 2;           // Referenced schema
  string ref_table = 3;            // Referenced table
  repeated string ref_columns = 4; // Referenced column(s)
  string on_delete = 5;            // CASCADE, SET NULL, etc.
}

// Index definition
message SqlIndex {
  string name = 1;                 // Index name
  repeated string columns = 2;     // Column(s) to index
  bool unique = 3;                 // UNIQUE index
  string where_clause = 4;         // Partial index condition
}

// =============================================================================
// Schema Definition (used by proto_to_sql.py)
// =============================================================================

// Master schema definition - can be embedded in any proto or standalone
message SqlSchema {
  string schema_name = 1;          // e.g., "rentearth"
  string owner = 2;                // e.g., "postgres"
  repeated SqlTableDef tables = 3;
  repeated SqlRpcDef rpcs = 4;     // RPC function definitions
}

// RPC function definition
message SqlRpcDef {
  string name = 1;                 // e.g., "load_character"
  string description = 2;          // Function comment
  repeated SqlRpcParam params = 3;
  string returns = 4;              // e.g., "json", "boolean", "uuid"
  string body_template = 5;        // Path to SQL template file
  bool security_definer = 6;       // SECURITY DEFINER
  repeated string grant_to = 7;    // e.g., ["service_role"]
}

message SqlRpcParam {
  string name = 1;                 // e.g., "p_user_id"
  string sql_type = 2;             // e.g., "uuid"
  string default_value = 3;        // Optional default
}
