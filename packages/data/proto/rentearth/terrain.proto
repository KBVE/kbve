syntax = "proto3";

package rentearth.terrain;

// ============================================================================
// Terrain Generation System
// ============================================================================
//
// This proto defines the terrain generation parameters shared between server
// and client. Both sides use identical FastNoise configurations to generate
// deterministic terrain from a shared seed.
//
// Architecture:
// - WorldTerrainConfig: Stored in DB (rentearth.world_config), sent on connect
// - TerrainNoiseConfig: FastNoise parameters for procedural generation
// - ChunkModification: Player modifications stored sparsely in DB
//
// Flow:
// 1. Server stores WorldTerrainConfig in DB
// 2. Client receives config via ConnectResponse
// 3. Both sides generate identical terrain using FastNoise + seed
// 4. Modifications (terraforming, buildings) stored as deltas
// ============================================================================

// ============================================================================
// FastNoise Configuration
// ============================================================================

// Noise algorithm type (maps to FastNoise Lite)
enum NoiseType {
  NOISE_TYPE_PERLIN = 0;
  NOISE_TYPE_OPENSIMPLEX2 = 1;
  NOISE_TYPE_OPENSIMPLEX2S = 2;
  NOISE_TYPE_CELLULAR = 3;
  NOISE_TYPE_VALUE = 4;
  NOISE_TYPE_VALUE_CUBIC = 5;
}

// Fractal type for layered noise
enum FractalType {
  FRACTAL_TYPE_NONE = 0;
  FRACTAL_TYPE_FBM = 1;              // Fractional Brownian Motion
  FRACTAL_TYPE_RIDGED = 2;           // Ridged multifractal
  FRACTAL_TYPE_PINGPONG = 3;         // Ping-pong fractal
}

// Cellular distance function (for NOISE_TYPE_CELLULAR)
enum CellularDistanceFunction {
  CELLULAR_DISTANCE_EUCLIDEAN = 0;
  CELLULAR_DISTANCE_EUCLIDEAN_SQ = 1;
  CELLULAR_DISTANCE_MANHATTAN = 2;
  CELLULAR_DISTANCE_HYBRID = 3;
}

// Cellular return type
enum CellularReturnType {
  CELLULAR_RETURN_CELL_VALUE = 0;
  CELLULAR_RETURN_DISTANCE = 1;
  CELLULAR_RETURN_DISTANCE2 = 2;
  CELLULAR_RETURN_DISTANCE2_ADD = 3;
  CELLULAR_RETURN_DISTANCE2_SUB = 4;
  CELLULAR_RETURN_DISTANCE2_MUL = 5;
  CELLULAR_RETURN_DISTANCE2_DIV = 6;
}

// Domain warp type
enum DomainWarpType {
  DOMAIN_WARP_NONE = 0;
  DOMAIN_WARP_OPENSIMPLEX2 = 1;
  DOMAIN_WARP_OPENSIMPLEX2_REDUCED = 2;
  DOMAIN_WARP_BASIC_GRID = 3;
}

// Complete noise configuration for terrain generation
// @sql.table: rentearth.world_config.noise_config (bytea)
message TerrainNoiseConfig {
  // Base noise settings
  NoiseType noise_type = 1;
  int32 seed = 2;                     // World seed (shared with server)
  float frequency = 3;                // Base frequency (default: 0.01)

  // Fractal settings
  FractalType fractal_type = 4;
  int32 octaves = 5;                  // Number of noise layers (default: 4)
  float lacunarity = 6;               // Frequency multiplier per octave (default: 2.0)
  float gain = 7;                     // Amplitude multiplier per octave (default: 0.5)
  float weighted_strength = 8;        // Fractal weighted strength (default: 0.0)
  float ping_pong_strength = 9;       // For FRACTAL_TYPE_PINGPONG (default: 2.0)

  // Cellular settings (only used if noise_type == CELLULAR)
  CellularDistanceFunction cellular_distance = 10;
  CellularReturnType cellular_return = 11;
  float cellular_jitter = 12;         // Cell randomness (default: 1.0)

  // Domain warp settings
  DomainWarpType domain_warp_type = 13;
  float domain_warp_amplitude = 14;   // Warp strength (default: 0.0 = disabled)
  float domain_warp_frequency = 15;   // Warp frequency (default: 0.05)

  // Height mapping
  float height_multiplier = 16;       // Max terrain height in world units (default: 50.0)
  float height_offset = 17;           // Base height offset (default: 0.0)

  // Height curve control points (for non-linear height mapping)
  // Format: [input0, output0, input1, output1, ...] where input/output are 0-1
  repeated float height_curve = 18;
}

// ============================================================================
// Biome Configuration
// ============================================================================

// Biome types for terrain variation
enum BiomeType {
  BIOME_TYPE_GRASSLAND = 0;
  BIOME_TYPE_FOREST = 1;
  BIOME_TYPE_DESERT = 2;
  BIOME_TYPE_MOUNTAIN = 3;
  BIOME_TYPE_SWAMP = 4;
  BIOME_TYPE_TUNDRA = 5;
  BIOME_TYPE_COAST = 6;
  BIOME_TYPE_VOLCANIC = 7;
}

// Biome selection parameters
message BiomeConfig {
  BiomeType biome_type = 1;

  // Climate range (0-1 normalized)
  float min_temperature = 2;
  float max_temperature = 3;
  float min_moisture = 4;
  float max_moisture = 5;

  // Terrain modifiers
  float height_scale = 6;             // Multiply base height (default: 1.0)
  float roughness = 7;                // Additional noise detail (default: 1.0)

  // Material/texture index for this biome
  int32 material_index = 8;
}

// Noise config specifically for biome selection (temperature/moisture)
message BiomeNoiseConfig {
  int32 seed_offset = 1;              // Added to world seed for variation
  float temperature_frequency = 2;    // Temperature noise frequency (default: 0.005)
  float moisture_frequency = 3;       // Moisture noise frequency (default: 0.007)
}

// ============================================================================
// World Terrain Configuration
// ============================================================================

// Complete world terrain configuration
// @sql.table: rentearth.world_config
// @sql.mapping:
//   world_id -> world_config.world_id (uuid)
//   world_seed -> world_config.world_seed (bigint)
//   [this message] -> world_config.terrain_config (bytea)
message WorldTerrainConfig {
  // Identity
  string world_id = 1;                // UUID of this world
  int64 world_seed = 2;               // Master seed for all generation

  // Chunk settings
  int32 chunk_size = 3;               // World units per chunk (default: 128)
  int32 chunk_resolution = 4;         // Vertices per chunk edge (default: 129 for 128x128)

  // World bounds (in chunk coordinates)
  int32 min_chunk_x = 5;
  int32 max_chunk_x = 6;
  int32 min_chunk_z = 7;
  int32 max_chunk_z = 8;

  // Generation config
  TerrainNoiseConfig height_noise = 9;
  BiomeNoiseConfig biome_noise = 10;
  repeated BiomeConfig biomes = 11;

  // LOD settings
  int32 max_lod_levels = 12;          // Number of LOD levels (default: 3)
  repeated float lod_distances = 13;  // Distance thresholds for each LOD

  // Pre-generation hints
  repeated ChunkCoord hot_chunks = 14; // Chunks to pre-generate (spawn areas, towns)

  // Version for cache invalidation
  int32 config_version = 15;
}

// Simple chunk coordinate
message ChunkCoord {
  int32 x = 1;
  int32 z = 2;
}

// ============================================================================
// Chunk Modifications (Player Changes)
// ============================================================================

// Type of modification applied to terrain
enum ModificationType {
  MODIFICATION_TYPE_NONE = 0;
  MODIFICATION_TYPE_TERRAFORM = 1;    // Height changes (digging, filling)
  MODIFICATION_TYPE_BUILDING = 2;     // Structure placed
  MODIFICATION_TYPE_ROAD = 3;         // Path/road placed
  MODIFICATION_TYPE_WATER = 4;        // Water body modified
  MODIFICATION_TYPE_VEGETATION = 5;   // Plants added/removed
}

// Single terrain modification within a chunk
message TerrainModification {
  // Local position within chunk (0 to chunk_size-1)
  int32 local_x = 1;
  int32 local_z = 2;

  // Modification data
  ModificationType mod_type = 3;
  float height_delta = 4;             // Height change (+/- from base)
  int32 material_override = 5;        // Override material index (-1 = no override)

  // For buildings/objects
  string placed_object_id = 6;        // Reference to placed object
}

// All modifications for a single chunk
// @sql.table: rentearth.chunk_modifications
// @sql.mapping:
//   chunk_x -> chunk_modifications.chunk_x (integer)
//   chunk_z -> chunk_modifications.chunk_z (integer)
//   [this message] -> chunk_modifications.mod_data (bytea)
message ChunkModifications {
  ChunkCoord coord = 1;
  repeated TerrainModification modifications = 2;

  // Metadata
  int64 last_modified_ms = 3;         // Unix timestamp
  bytes last_modified_by = 4;         // Player UUID who last modified
}

// ============================================================================
// Runtime Messages (Client <-> Server)
// ============================================================================

// Client requests modifications for chunks entering view
message ChunkModificationsRequest {
  repeated ChunkCoord chunks = 1;
}

// Server responds with modifications (only for chunks that have any)
message ChunkModificationsResponse {
  repeated ChunkModifications chunk_mods = 1;
}

// Client requests to modify terrain (server authoritative)
message TerraformRequest {
  ChunkCoord chunk = 1;
  TerrainModification modification = 2;
}

// Server confirms or rejects terraform
message TerraformResponse {
  bool success = 1;
  string error = 2;
  ChunkModifications updated_chunk = 3; // Full chunk mods after change
}

// ============================================================================
// Pre-computed Chunk Data (Optional - for complex terrain)
// ============================================================================

// Pre-computed heightmap for a chunk (alternative to runtime generation)
// Use this for chunks with complex features that can't be procedurally generated
// @sql.table: rentearth.precomputed_chunks (optional)
message PrecomputedChunk {
  ChunkCoord coord = 1;

  // Heightmap data (row-major, resolution x resolution floats)
  repeated float heights = 2;

  // Biome data per vertex (optional, for biome blending)
  repeated int32 biome_indices = 3;

  // Material weights per vertex (optional, for texture splatting)
  // Format: [v0_mat0, v0_mat1, v0_mat2, v0_mat3, v1_mat0, ...]
  repeated float material_weights = 4;

  // Metadata
  int32 resolution = 5;
  int64 computed_at_ms = 6;
  int32 config_version = 7;           // Must match WorldTerrainConfig.config_version
}
