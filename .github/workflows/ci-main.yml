name: CI - Main

on:
    workflow_dispatch:
    push:
        branches:
            - main

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: false

permissions: {}

env:
    REGISTRY: ghcr.io
    IMAGE_NAME: ${{ github.repository }}

jobs:
    globals:
        runs-on: ubuntu-latest
        timeout-minutes: 10
        name: Global Variables
        outputs:
            sha256head: ${{ steps.hash.outputs.sha256head }}

        steps:
            - name: Checkout Code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Configure Git
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

            - name: Calculate SHA-256 Hash
              id: hash
              run: |
                  echo "sha256head=$(echo -n ${{ github.sha }} | sha256sum | awk '{print $1}')" >> $GITHUB_OUTPUT

    call_sync:
        needs: ['globals']
        name: 'Call Sync Workflow'
        permissions:
            contents: write
            issues: write
        uses: KBVE/kbve/.github/workflows/ci-sync.yml@main
        secrets:
            UNITY_PAT: ${{ secrets.UNITY_PAT }}

    alter:
        needs: ['globals']
        name: 'Alpha Alters'
        if: github.repository == 'kbve/kbve'
        permissions:
            contents: read
        uses: KBVE/kbve/.github/workflows/utils-file-alterations.yml@main
        with:
            branch: 'main'

    deploy:
        needs: ['alter', 'globals']
        name: Deployment
        runs-on: ubuntu-latest
        timeout-minutes: 10
        steps:
            - name: Checkout the repository using git
              uses: actions/checkout@v6

            - name: Setup Node v24
              uses: actions/setup-node@v6
              with:
                  node-version: 24

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 10
                  run_install: false
            #   @[CACHE]->[START]
            - name: Get pnpm Store
              id: pnpm-store
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

            - name: Setup pnpm Cache
              uses: actions/cache@v5
              with:
                  path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml', 'package.json') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

    ## Godot
    generate_godot_matrix:
        needs: ['deploy', 'alter', 'globals']
        uses: KBVE/kbve/.github/workflows/utils-generate-matrix.yml@main
        with:
            items: |
                [
                    {
                        "name": "pirate17",
                        "condition": "${{ needs.alter.outputs.pirate17 == 'true' }}",
                        "project": "pirate17",
                        "branch": "main",
                        "deploy_to_itch": true,
                        "export_name": "pirate17",
                        "project_path": "./apps/gamejam/pirate/pirate17",
                        "build_artifact_name": "pirate17",
                        "itch_username": "kbve",
                        "itch_gameid": "airship",
                        "godot_version": "4.4.1"
                    }
                ]

    publish_godot:
        name: Publish Godot Game on Itch
        needs: ['generate_godot_matrix']
        if: ${{ needs.generate_godot_matrix.outputs.matrix != 'null' }}
        permissions:
            contents: read
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.generate_godot_matrix.outputs.matrix) }}
        uses: KBVE/kbve/.github/workflows/utils-godot-itch-build-pipeline.yml@main
        with:
            branch: ${{ matrix.branch }}
            deploy_to_itch: ${{ matrix.deploy_to_itch }}
            godot_version: ${{ matrix.godot_version }}
            export_name: ${{ matrix.export_name }}
            project_path: ${{ matrix.project_path }}
            build_artifact_name: ${{ matrix.build_artifact_name }}
            itch_username: ${{ matrix.itch_username }}
            itch_gameid: ${{ matrix.itch_gameid }}
        secrets:
            butler_api: ${{ secrets.ITCH_API }}

    ## NPM
    generate_npm_matrix:
        needs: ['deploy', 'alter', 'globals']
        uses: KBVE/kbve/.github/workflows/utils-generate-matrix.yml@main
        with:
            items: |
                [
                    {
                      "name": "droid",
                      "condition": "${{ needs.alter.outputs.droid == 'true' }}",
                      "project": "droid"
                    },
                    {
                      "name": "laser",
                      "condition": "${{ needs.alter.outputs.laser == 'true' }}",
                      "project": "laser"
                    },
                    {
                      "name": "devops",
                      "condition": "${{ needs.alter.outputs.devops == 'true' }}",
                      "project": "devops"
                    },
                    {
                      "name": "khashvault",
                      "condition": "${{ needs.alter.outputs.khashvault == 'true' }}",
                      "project": "khashvault"
                    }
                ]

    test_npm:
        name: Test NPM
        needs: ['generate_npm_matrix']
        if: ${{ needs.generate_npm_matrix.outputs.matrix != 'null' }}
        permissions:
            contents: read
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.generate_npm_matrix.outputs.matrix) }}
        uses: KBVE/kbve/.github/workflows/npm-test-package.yml@main
        with:
            project: ${{ matrix.project }}

    collect_npm_results:
        needs: ['test_npm', 'generate_npm_matrix']
        name: Collect NPM Test Results
        if: ${{ always() && needs.generate_npm_matrix.outputs.matrix != 'null' }}
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.filter.outputs.matrix }}
        steps:
            - name: Download test markers
              uses: actions/download-artifact@v4
              with:
                  pattern: test-passed-npm-*
                  path: ./test-results
              continue-on-error: true

            - name: Build filtered publish matrix
              id: filter
              env:
                  FULL_MATRIX: ${{ needs.generate_npm_matrix.outputs.matrix }}
              run: |
                  if [ -d "./test-results" ]; then
                    PASSED=$(ls ./test-results/ | sed 's/test-passed-npm-//')
                  else
                    PASSED=""
                  fi
                  FILTERED=$(echo "$FULL_MATRIX" | jq -c --arg passed "$PASSED" '{
                    include: [.include[] | select(.name as $n | $passed | split("\n") | any(. == $n))]
                  } | if (.include | length) == 0 then null else . end')
                  echo "matrix=$FILTERED" >> "$GITHUB_OUTPUT"

    publish_npm:
        name: Publish NPM
        needs: ['collect_npm_results']
        if: ${{ needs.collect_npm_results.outputs.matrix != 'null' }}
        permissions:
            contents: read
            id-token: write
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.collect_npm_results.outputs.matrix) }}
        uses: KBVE/kbve/.github/workflows/utils-npm-publish.yml@main
        with:
            project: ${{ matrix.project }}
        secrets:
            NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

    ## Astro
    # NOTE: astro_memes GitHub Pages deployment removed — meme.sh is now deployed
    # exclusively via the Docker/k8s pipeline (axum-memes container triggered by `memes` output).

    #  Unity matrix — currently empty after rareicon removal.
    #  Re-add entries here when new Unity projects are onboarded.
    #  generate_unity_matrix / build_unity jobs temporarily removed.

    generate_crates_matrix:
        needs: ['deploy', 'alter', 'globals']
        uses: KBVE/kbve/.github/workflows/utils-generate-matrix.yml@main
        with:
            items: |
                [
                  { "name": "q", "condition": "${{ needs.alter.outputs.q_crate }}" },
                  { "name": "jedi", "condition": "${{ needs.alter.outputs.jedi_crate }}" },
                  { "name": "soul", "condition": "${{ needs.alter.outputs.soul_crate }}" },
                  { "name": "kbve", "condition": "${{ needs.alter.outputs.kbve_crate }}" },
                  { "name": "erust", "condition": "${{ needs.alter.outputs.erust_crate }}" },
                  { "name": "holy", "condition": "${{ needs.alter.outputs.holy_crate }}" }
                ]

    test_crates:
        needs: ['generate_crates_matrix']
        name: Test Rust Crates
        if: ${{ needs.generate_crates_matrix.outputs.matrix != 'null' }}
        permissions:
            contents: read
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.generate_crates_matrix.outputs.matrix) }}
        uses: KBVE/kbve/.github/workflows/rust-test-crate.yml@main
        with:
            package: ${{ matrix.name }}

    collect_crate_results:
        needs: ['test_crates', 'generate_crates_matrix']
        name: Collect Crate Test Results
        if: ${{ always() && needs.generate_crates_matrix.outputs.matrix != 'null' }}
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.filter.outputs.matrix }}
        steps:
            - name: Download test markers
              uses: actions/download-artifact@v4
              with:
                  pattern: test-passed-crate-*
                  path: ./test-results
              continue-on-error: true

            - name: Build filtered publish matrix
              id: filter
              env:
                  FULL_MATRIX: ${{ needs.generate_crates_matrix.outputs.matrix }}
              run: |
                  if [ -d "./test-results" ]; then
                    PASSED=$(ls ./test-results/ | sed 's/test-passed-crate-//')
                  else
                    PASSED=""
                  fi
                  FILTERED=$(echo "$FULL_MATRIX" | jq -c --arg passed "$PASSED" '{
                    include: [.include[] | select(.name as $n | $passed | split("\n") | any(. == $n))]
                  } | if (.include | length) == 0 then null else . end')
                  echo "matrix=$FILTERED" >> "$GITHUB_OUTPUT"

    publish_crates:
        needs: ['collect_crate_results']
        name: Publish Rust Crates
        if: ${{ needs.collect_crate_results.outputs.matrix != 'null' }}
        permissions:
            id-token: write
            contents: write
            packages: write
            issues: write
            pull-requests: write
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.collect_crate_results.outputs.matrix) }}
        uses: KBVE/kbve/.github/workflows/rust-publish-crate.yml@main
        with:
            package: ${{ matrix.name }}
        secrets:
            CRATES_TOKEN: ${{ secrets.CRATES_TOKEN }}

    ## Base Docker images (built before downstream images that depend on them)
    generate_base_docker_matrix:
        needs: ['deploy', 'alter', 'globals']
        uses: KBVE/kbve/.github/workflows/utils-generate-matrix.yml@main
        with:
            items: |
                [
                  { "name": "mc", "target": "base", "condition": "${{ needs.alter.outputs.mc_base }}", "image": "ghcr.io/kbve/mc-rust-base" }
                ]

    build_base_images:
        needs: ['generate_base_docker_matrix']
        name: Build Base Images
        if: ${{ needs.generate_base_docker_matrix.outputs.matrix != 'null' }}
        permissions:
            contents: read
            packages: write
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.generate_base_docker_matrix.outputs.matrix) }}
        uses: KBVE/kbve/.github/workflows/utils-publish-docker-image.yml@main
        with:
            project: ${{ matrix.name }}
            target: ${{ matrix.target }}
            image: ${{ matrix.image }}
        secrets:
            DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
            DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
            MY_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    generate_docker_matrix:
        needs: ['deploy', 'alter', 'globals']
        uses: KBVE/kbve/.github/workflows/utils-generate-matrix.yml@main
        with:
            items: |
                [
                  { "name": "kilobase", "target": "container", "condition": "${{ needs.alter.outputs.kilobase }}" },
                  { "name": "herbmail", "target": "container", "condition": "${{ needs.alter.outputs.herbmail }}", "e2e_name": "herbmail", "image": "kbve/herbmail", "cargo_toml": "apps/herbmail/axum-herbmail/Cargo.toml" },
                  { "name": "memes", "target": "container", "condition": "${{ needs.alter.outputs.memes }}", "e2e_name": "memes", "image": "kbve/memes", "cargo_toml": "apps/memes/axum-memes/Cargo.toml" },
                  { "name": "irc-gateway", "target": "container", "condition": "${{ needs.alter.outputs.irc_gateway }}", "e2e_name": "irc", "image": "kbve/irc-gateway", "cargo_toml": "apps/irc/irc-gateway/Cargo.toml" },
                  { "name": "discordsh", "target": "container", "condition": "${{ needs.alter.outputs.discordsh }}", "e2e_name": "discordsh", "image": "kbve/discordsh", "cargo_toml": "apps/discordsh/axum-discordsh/Cargo.toml" },
                  { "name": "mc", "target": "container", "condition": "${{ needs.alter.outputs.mc }}", "e2e_name": "mc", "image": "kbve/mc" },
                  { "name": "edge", "target": "container", "condition": "${{ needs.alter.outputs.edge }}", "e2e_name": "edge", "image": "kbve/edge", "cargo_toml": "apps/kbve/edge/version.toml" }
                ]

    generate_e2e_docker_matrix:
        needs: ['deploy', 'alter', 'globals']
        uses: KBVE/kbve/.github/workflows/utils-generate-matrix.yml@main
        with:
            items: |
                [
                  { "name": "herbmail", "condition": "${{ needs.alter.outputs.herbmail }}" },
                  { "name": "memes", "condition": "${{ needs.alter.outputs.memes }}" },
                  { "name": "irc", "condition": "${{ needs.alter.outputs.irc_gateway }}" },
                  { "name": "discordsh", "condition": "${{ needs.alter.outputs.discordsh }}" },
                  { "name": "mc", "condition": "${{ needs.alter.outputs.mc }}" },
                  { "name": "edge", "condition": "${{ needs.alter.outputs.edge }}" }
                ]

    test_docker:
        needs: ['generate_e2e_docker_matrix', 'build_base_images']
        name: Test Docker Apps
        if: ${{ always() && !cancelled() && !failure() && needs.generate_e2e_docker_matrix.outputs.matrix != 'null' }}
        permissions:
            contents: read
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.generate_e2e_docker_matrix.outputs.matrix) }}
        uses: KBVE/kbve/.github/workflows/docker-test-app.yml@main
        with:
            project: ${{ matrix.name }}

    collect_docker_results:
        needs:
            [
                'test_docker',
                'generate_docker_matrix',
                'generate_e2e_docker_matrix',
            ]
        name: Collect Docker Test Results
        if: ${{ always() && needs.generate_docker_matrix.outputs.matrix != 'null' }}
        runs-on: ubuntu-latest
        outputs:
            publish_matrix: ${{ steps.filter.outputs.publish_matrix }}
        steps:
            - name: Download test markers
              uses: actions/download-artifact@v4
              with:
                  pattern: test-passed-docker-*
                  path: ./test-results
              continue-on-error: true

            - name: Build filtered publish matrix
              id: filter
              env:
                  PUBLISH_MATRIX: ${{ needs.generate_docker_matrix.outputs.matrix }}
              run: |
                  echo "::group::Debug test-results directory"
                  if [ -d "./test-results" ]; then
                    echo "Directory exists, contents:"
                    ls -la ./test-results/
                    PASSED=$(ls ./test-results/ | sed 's/test-passed-docker-//')
                    echo "PASSED entries:"
                    echo "$PASSED"
                  else
                    echo "Directory does not exist"
                    PASSED=""
                  fi
                  echo "::endgroup::"
                  echo "::group::Debug matrix filter"
                  echo "PUBLISH_MATRIX=$PUBLISH_MATRIX"
                  FILTERED=$(echo "$PUBLISH_MATRIX" | jq -c --arg passed "$PASSED" '{
                    include: [.include[] | select(
                      (.e2e_name | not) or
                      (.e2e_name as $e | $passed | split("\n") | any(. == $e))
                    )]
                  } | if (.include | length) == 0 then null else . end')
                  echo "FILTERED=$FILTERED"
                  echo "::endgroup::"
                  echo "publish_matrix=$FILTERED" >> "$GITHUB_OUTPUT"

    publish_docker:
        needs: ['collect_docker_results']
        name: Publish Docker Images
        if: ${{ always() && !cancelled() && needs.collect_docker_results.outputs.publish_matrix != 'null' }}
        permissions:
            contents: read
            packages: write
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.collect_docker_results.outputs.publish_matrix) }}
        uses: KBVE/kbve/.github/workflows/utils-publish-docker-image.yml@main
        with:
            project: ${{ matrix.name }}
            target: ${{ matrix.target }}
            image: ${{ matrix.image || '' }}
            cargo_toml: ${{ matrix.cargo_toml || '' }}
        secrets:
            DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
            DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
            MY_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    generate_kube_update_matrix:
        needs: ['deploy', 'alter', 'globals']
        uses: KBVE/kbve/.github/workflows/utils-generate-matrix.yml@main
        with:
            items: |
                [
                  { "name": "herbmail", "condition": "${{ needs.alter.outputs.herbmail }}", "e2e_name": "herbmail", "image_name": "ghcr.io/kbve/herbmail", "cargo_toml": "apps/herbmail/axum-herbmail/Cargo.toml", "deployment_yaml": "apps/kube/herbmail/manifest/herbmail-deployment.yaml" },
                  { "name": "memes", "condition": "${{ needs.alter.outputs.memes }}", "e2e_name": "memes", "image_name": "ghcr.io/kbve/memes", "cargo_toml": "apps/memes/axum-memes/Cargo.toml", "deployment_yaml": "apps/kube/memes/manifest/memes-deployment.yaml" },
                  { "name": "irc-gateway", "condition": "${{ needs.alter.outputs.irc_gateway }}", "e2e_name": "irc", "image_name": "ghcr.io/kbve/irc-gateway", "cargo_toml": "apps/irc/irc-gateway/Cargo.toml", "deployment_yaml": "apps/kube/irc/manifests/irc-gateway-deployment.yaml" },
                  { "name": "discordsh", "condition": "${{ needs.alter.outputs.discordsh }}", "e2e_name": "discordsh", "image_name": "ghcr.io/kbve/discordsh", "cargo_toml": "apps/discordsh/axum-discordsh/Cargo.toml", "deployment_yaml": "apps/kube/discordsh/manifest/deployment.yaml" },
                  { "name": "mc", "condition": "${{ needs.alter.outputs.mc }}", "e2e_name": "mc", "image_name": "ghcr.io/kbve/mc", "cargo_toml": "apps/mc/plugins/kbve-mc-plugin/Cargo.toml", "deployment_yaml": "apps/kube/mc/manifest/deployment.yaml" },
                  { "name": "edge", "condition": "${{ needs.alter.outputs.edge }}", "e2e_name": "edge", "image_name": "ghcr.io/kbve/edge", "cargo_toml": "apps/kbve/edge/version.toml", "deployment_yaml": "apps/kube/functions/manifests/functions-deployment.yaml" }
                ]

    collect_kube_results:
        needs:
            [
                'publish_docker',
                'generate_kube_update_matrix',
                'collect_docker_results',
            ]
        name: Collect Kube Update Results
        if: ${{ always() && needs.generate_kube_update_matrix.outputs.matrix != 'null' }}
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.filter.outputs.matrix }}
        steps:
            - name: Download test markers
              uses: actions/download-artifact@v4
              with:
                  pattern: test-passed-docker-*
                  path: ./test-results
              continue-on-error: true

            - name: Build filtered kube matrix
              id: filter
              env:
                  KUBE_MATRIX: ${{ needs.generate_kube_update_matrix.outputs.matrix }}
              run: |
                  echo "::group::Debug test-results directory"
                  if [ -d "./test-results" ]; then
                    echo "Directory exists, contents:"
                    ls -la ./test-results/
                    PASSED=$(ls ./test-results/ | sed 's/test-passed-docker-//')
                    echo "PASSED entries:"
                    echo "$PASSED"
                  else
                    echo "Directory does not exist"
                    PASSED=""
                  fi
                  echo "::endgroup::"
                  echo "::group::Debug matrix filter"
                  echo "KUBE_MATRIX=$KUBE_MATRIX"
                  FILTERED=$(echo "$KUBE_MATRIX" | jq -c --arg passed "$PASSED" '{
                    include: [.include[] | select(
                      (.e2e_name | not) or
                      (.e2e_name as $e | $passed | split("\n") | any(. == $e))
                    )]
                  } | if (.include | length) == 0 then null else . end')
                  echo "FILTERED=$FILTERED"
                  echo "::endgroup::"
                  echo "matrix=$FILTERED" >> "$GITHUB_OUTPUT"

    update_kube_manifests:
        needs: ['collect_kube_results']
        name: Update Kube Manifests
        if: ${{ always() && !cancelled() && needs.collect_kube_results.outputs.matrix != 'null' }}
        permissions:
            contents: write
            pull-requests: write
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.collect_kube_results.outputs.matrix) }}
        uses: KBVE/kbve/.github/workflows/utils-update-kube-manifest.yml@main
        with:
            app_name: ${{ matrix.name }}
            image_name: ${{ matrix.image_name }}
            cargo_toml: ${{ matrix.cargo_toml }}
            deployment_yaml: ${{ matrix.deployment_yaml }}

    #   ! Everything below this line will be removed and replaced with the matrix setup.

    #   [CryptoThrone]
    cryptothrone_build_process:
        needs: ['deploy', 'alter', 'globals']
        name: CryptoThrone Build and Deployment
        if: needs.alter.outputs.cryptothrone == 'true'
        runs-on: 'ubuntu-latest'
        timeout-minutes: 30
        permissions:
            contents: read
            id-token: write
        steps:
            - name: Checkout the monorepo using git
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Setup Node v24
              uses: actions/setup-node@v6
              with:
                  node-version: 24

            - name: Setup pnpm
              uses: pnpm/action-setup@v4
              with:
                  version: 9
                  run_install: false

            - name: Get pnpm Store
              id: pnpm-store
              shell: bash
              run: |
                  echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

            - name: Setup pnpm Cache
              uses: actions/cache@v5
              with:
                  path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml', 'package.json') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install pnpm dependencies
              shell: bash
              run: |
                  pnpm install

            - name: Build CryptoThrone.com
              shell: bash
              run: |
                  pnpm nx build cryptothrone.com
            - name: CryptoThrone.com -> Deployment
              uses: dobbelina/copy_file_to_another_repo_action@main
              env:
                  API_TOKEN_GITHUB: ${{ secrets.UNITY_PAT }}
              with:
                  source_file: 'dist/apps/cryptothrone.com/'
                  destination_repo: 'KBVE/cryptothrone.com'
                  destination_folder: '/docs'
                  destination_branch: 'main'
                  destination_branch_create: 'patch-cryptothrone-deploy-${{ needs.globals.outputs.sha256head }}'
                  user_email: '5599058+h0lybyte@users.noreply.github.com'
                  user_name: 'h0lybyte'
                  commit_message: ${{ github.event.head_commit.message }}
                  rsync_option: '-avrh --delete'

    ## Python
    generate_python_matrix:
        needs: ['deploy', 'alter', 'globals']
        uses: KBVE/kbve/.github/workflows/utils-generate-matrix.yml@main
        with:
            items: |
                [
                    {
                      "name": "python-fudster",
                      "condition": "${{ needs.alter.outputs.py_lib_fudster == 'true' }}",
                      "project": "python-fudster",
                      "pypi_name": "fudster"
                    },
                    {
                      "name": "python-kbve",
                      "condition": "${{ needs.alter.outputs.py_lib_kbve == 'true' }}",
                      "project": "python-kbve",
                      "pypi_name": "kbve"
                    }
                ]

    test_python:
        name: Test Python
        needs: ['generate_python_matrix']
        if: ${{ needs.generate_python_matrix.outputs.matrix != 'null' }}
        permissions:
            contents: read
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.generate_python_matrix.outputs.matrix) }}
        uses: KBVE/kbve/.github/workflows/python-test-package.yml@main
        with:
            project: ${{ matrix.project }}

    collect_python_results:
        needs: ['test_python', 'generate_python_matrix']
        name: Collect Python Test Results
        if: ${{ always() && needs.generate_python_matrix.outputs.matrix != 'null' }}
        runs-on: ubuntu-latest
        outputs:
            matrix: ${{ steps.filter.outputs.matrix }}
        steps:
            - name: Download test markers
              uses: actions/download-artifact@v4
              with:
                  pattern: test-passed-python-*
                  path: ./test-results
              continue-on-error: true

            - name: Build filtered publish matrix
              id: filter
              env:
                  FULL_MATRIX: ${{ needs.generate_python_matrix.outputs.matrix }}
              run: |
                  if [ -d "./test-results" ]; then
                    PASSED=$(ls ./test-results/ | sed 's/test-passed-python-//')
                  else
                    PASSED=""
                  fi
                  FILTERED=$(echo "$FULL_MATRIX" | jq -c --arg passed "$PASSED" '{
                    include: [.include[] | select(.name as $n | $passed | split("\n") | any(. == $n))]
                  } | if (.include | length) == 0 then null else . end')
                  echo "matrix=$FILTERED" >> "$GITHUB_OUTPUT"

    publish_python:
        name: Publish Python
        needs: ['collect_python_results']
        if: ${{ needs.collect_python_results.outputs.matrix != 'null' }}
        permissions:
            contents: read
            id-token: write
        strategy:
            fail-fast: false
            matrix: ${{ fromJson(needs.collect_python_results.outputs.matrix) }}
        uses: KBVE/kbve/.github/workflows/utils-python-publish.yml@main
        with:
            project: ${{ matrix.project }}
            pypi_name: ${{ matrix.pypi_name }}
        secrets:
            PYPI_TOKEN: ${{ secrets.PYPI_API_SCOPE_TOKEN }}
