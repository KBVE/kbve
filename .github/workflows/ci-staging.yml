# Fix for ci-staging.yml - Handle "No commits between" error

name: CI - Staging

on:
    push:
        branches:
            - 'staging'
    pull_request:
        branches:
            - 'main'
        types: [opened, synchronize, reopened]

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions: {}

jobs:
    staging_to_main_pr:
        name: 'Create/Update Staging to Main PR'
        runs-on: ubuntu-latest
        if: github.event_name == 'push' && github.ref_name == 'staging'
        timeout-minutes: 10
        permissions:
            contents: read
            pull-requests: write
            issues: write

        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Check if staging has changes to release
              id: check_changes
              uses: actions/github-script@v8
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      // Compare staging with main to see if there are changes
                      try {
                          const comparison = await github.rest.repos.compareCommits({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              base: 'main',
                              head: 'staging'
                          });
                          
                          const commitCount = comparison.data.commits.length;
                          console.log(`Found ${commitCount} commits between main and staging`);
                          
                          if (commitCount === 0) {
                              console.log('Staging is up-to-date with main - no PR needed');
                              return {
                                  hasChanges: false,
                                  commitCount: 0,
                                  message: 'Staging is already up-to-date with main'
                              };
                          }
                          
                          console.log(`Staging has ${commitCount} commits ready for release`);
                          return {
                              hasChanges: true,
                              commitCount: commitCount,
                              commits: comparison.data.commits
                          };
                          
                      } catch (error) {
                          console.log(`Error comparing branches: ${error.message}`);
                          return {
                              hasChanges: false,
                              commitCount: 0,
                              error: error.message
                          };
                      }

            - name: Skip PR creation - no changes
              if: fromJson(steps.check_changes.outputs.result).hasChanges == false
              run: |
                  echo "Staging to Main PR Status: UP TO DATE"
                  echo "Staging branch is already synchronized with main"
                  echo "No new changes to release"
                  echo ""
                  echo "This is normal and indicates:"
                  echo "- Previous release was successfully merged"
                  echo "- No new features have been promoted to staging yet" 
                  echo "- System is in a clean state"

            - name: Check if staging→main PR exists
              if: fromJson(steps.check_changes.outputs.result).hasChanges == true
              id: check_pr
              uses: actions/github-script@v8
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const existingPRs = await github.rest.pulls.list({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        head: `${context.repo.owner}:staging`,
                        base: 'main',
                        state: 'open'
                      });

                      if (existingPRs.data.length > 0) {
                        console.log(`Found existing PR: #${existingPRs.data[0].number}`);
                        return {
                          exists: true,
                          number: existingPRs.data[0].number,
                          url: existingPRs.data[0].html_url
                        };
                      } else {
                        console.log('No existing staging→main PR found');
                        return { exists: false };
                      }

            - name: Create or update staging→main PR
              if: fromJson(steps.check_changes.outputs.result).hasChanges == true
              id: upsert_pr
              uses: actions/github-script@v8
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}
                  script: |
                      const path = require('path');
                      const utils = await import(path.resolve('.github/scripts/commit-utils.mjs'));

                      const checkResult = ${{ steps.check_pr.outputs.result || 'null' }};

                      // Get commits between main and staging
                      const comparison = await github.rest.repos.compareCommits({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        base: 'main',
                        head: 'staging'
                      });

                      const rawCommits = comparison.data.commits.map(c => ({
                        message: c.commit.message,
                        sha: c.sha
                      }));
                      console.log(`Found ${rawCommits.length} commits`);

                      const { categories, prRefs } = utils.categorizeCommits(rawCommits);
                      const title = `Production Release: ${utils.generateTitle(categories, 'Main').replace('Release: ', '')}`;
                      const body = utils.formatStagingToMainBody(categories, rawCommits.length, prRefs.size);

                      let prNumber;
                      if (checkResult && checkResult.exists) {
                        prNumber = checkResult.number;
                      } else {
                        // Create new PR
                        const pr = await github.rest.pulls.create({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          title,
                          head: 'staging',
                          base: 'main',
                          body,
                          draft: false
                        });
                        prNumber = pr.data.number;

                        await github.rest.issues.addLabels({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: prNumber,
                          labels: ['production', 'staging→main', 'auto-pr']
                        });

                        console.log(`Created PR #${prNumber}`);
                      }

                      // Always update title and body to reflect latest commits
                      await github.rest.pulls.update({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        pull_number: prNumber,
                        title,
                        body
                      });

                      console.log(`Updated PR #${prNumber} — ${title}`);
                      return { number: prNumber };

            - name: Summary
              run: |
                  if [[ "${{ fromJson(steps.check_changes.outputs.result).hasChanges }}" == "true" ]]; then
                      echo "Staging→Main PR: CREATED/UPDATED"
                      echo "Commits ready for release: ${{ fromJson(steps.check_changes.outputs.result).commitCount }}"
                  else
                      echo "Staging→Main PR: NOT NEEDED"
                      echo "Staging is already up-to-date with main"
                  fi

    validate_staging_pr:
        name: 'Validate Staging→Main PR'
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request' && github.base_ref == 'main' && github.head_ref == 'staging'
        timeout-minutes: 30
        permissions:
            contents: read
        steps:
            - name: Checkout
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Check for conflicts
              run: |
                  echo "Checking for merge conflicts..."

                  # Try to merge main into staging (dry run)
                  git config user.name "CI Bot"
                  git config user.email "ci@example.com"

                  if git merge --no-commit --no-ff origin/main; then
                    echo "No merge conflicts detected"
                    git merge --abort
                  else
                    echo "Merge conflicts detected! Please resolve before merging."
                    git merge --abort
                    exit 1
                  fi

            - name: Setup Node v24
              uses: actions/setup-node@v6
              with:
                  node-version: 24

            - name: Setup pnpm v10
              uses: pnpm/action-setup@v4
              with:
                  version: 10
                  run_install: false

            - name: Get pnpm Store Path
              id: pnpm-store
              run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

            - name: Setup pnpm Cache
              uses: actions/cache@v5
              with:
                  path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml', 'package.json') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install pnpm Dependencies
              run: pnpm install

            - name: Setup Python
              uses: actions/setup-python@v6
              with:
                  python-version: '3.12'

            - name: Install uv
              uses: astral-sh/setup-uv@v7

            - name: Lint affected projects
              run: pnpm nx affected --target=lint --base=origin/main --head=origin/staging --no-cloud

            - name: Test affected projects
              run: pnpm nx affected --target=test --base=origin/main --head=origin/staging --no-cloud
