name: Docker Image Publish

on:
    workflow_call:
        inputs:
            project:
                required: true
                type: string
            target:
                required: true
                type: string
            image:
                required: false
                type: string
                default: ''
            cargo_toml:
                description: 'Path to Cargo.toml to read version from'
                required: false
                type: string
                default: ''
            branch:
                required: false
                type: string
                default: main
        secrets:
            MY_GITHUB_TOKEN:
                required: true
            DOCKERHUB_USERNAME:
                required: true
            DOCKERHUB_TOKEN:
                required: true

jobs:
    publish:
        runs-on: ubuntu-latest
        timeout-minutes: 60
        permissions:
            contents: read
            packages: write

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v6
              with:
                  ref: ${{ inputs.branch }}
                  submodules: true

            - name: Check version against Docker Hub
              id: version_check
              if: ${{ inputs.image != '' && inputs.cargo_toml != '' }}
              run: |
                  LOCAL_VERSION=$(grep -m1 '^version' "${{ inputs.cargo_toml }}" \
                    | sed 's/version = "\(.*\)"/\1/')
                  echo "Local version from Cargo.toml: $LOCAL_VERSION"

                  STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
                    "https://hub.docker.com/v2/repositories/${{ inputs.image }}/tags/$LOCAL_VERSION")

                  if [ "$STATUS" = "200" ]; then
                    echo "Tag $LOCAL_VERSION already exists on Docker Hub — skipping."
                    echo "should_publish=false" >> "$GITHUB_OUTPUT"
                  else
                    echo "Tag $LOCAL_VERSION not found (HTTP $STATUS) — publishing."
                    echo "should_publish=true" >> "$GITHUB_OUTPUT"
                  fi

            - name: Setup Node v24
              if: ${{ steps.version_check.outputs.should_publish != 'false' }}
              uses: actions/setup-node@v6
              with:
                  node-version: 24

            - name: Setup pnpm v10
              if: ${{ steps.version_check.outputs.should_publish != 'false' }}
              uses: pnpm/action-setup@v4
              with:
                  version: 10
                  run_install: false

            - name: Get pnpm Store
              if: ${{ steps.version_check.outputs.should_publish != 'false' }}
              id: pnpm-store
              run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

            - name: Setup pnpm Cache
              if: ${{ steps.version_check.outputs.should_publish != 'false' }}
              uses: actions/cache@v5
              with:
                  path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
                  key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml', 'package.json') }}
                  restore-keys: |
                      ${{ runner.os }}-pnpm-store-

            - name: Install pnpm Dependencies
              if: ${{ steps.version_check.outputs.should_publish != 'false' }}
              run: pnpm install

            - name: Set up QEMU
              if: ${{ steps.version_check.outputs.should_publish != 'false' }}
              uses: docker/setup-qemu-action@v3

            - name: Set up Docker Buildx
              if: ${{ steps.version_check.outputs.should_publish != 'false' }}
              uses: docker/setup-buildx-action@v3

            - name: Login to Docker Hub
              if: ${{ steps.version_check.outputs.should_publish != 'false' }}
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Login to GHCR
              if: ${{ steps.version_check.outputs.should_publish != 'false' }}
              uses: docker/login-action@v3
              with:
                  registry: ghcr.io
                  username: ${{ github.actor }}
                  password: ${{ secrets.MY_GITHUB_TOKEN }}

            - name: Build Docker Image with Nx
              if: ${{ steps.version_check.outputs.should_publish != 'false' }}
              env:
                  INPUT_GITHUB_TOKEN: ${{ secrets.MY_GITHUB_TOKEN }}
              run: |
                  pnpm nx run ${{ inputs.project }}:${{ inputs.target }} --configuration=production

            - name: Scan Docker image with Trivy
              if: ${{ steps.version_check.outputs.should_publish != 'false' && inputs.image != '' }}
              uses: aquasecurity/trivy-action@0.34.1
              with:
                  image-ref: ${{ inputs.image }}:latest
                  format: table
                  exit-code: 0
                  severity: CRITICAL,HIGH
                  ignore-unfixed: true

            - name: Push Docker Images
              if: ${{ steps.version_check.outputs.should_publish != 'false' && inputs.image != '' }}
              run: |
                  IMAGES=$(docker images --format '{{.Repository}}:{{.Tag}}' | grep -E '${{ inputs.image }}' | grep -v '<none>' || true)
                  if [ -z "$IMAGES" ]; then
                    echo "::error::No images found matching '${{ inputs.image }}'. Listing all images:"
                    docker images
                    exit 1
                  fi
                  echo "Pushing images:"
                  echo "$IMAGES"
                  for IMG in $IMAGES; do
                    docker push "$IMG"
                  done
