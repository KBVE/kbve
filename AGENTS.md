# Worktree Workflow

All work must happen in isolated git worktrees branched from `dev`. Never commit directly to `dev` or `main`.

## Flow

1. **Create worktree** using `kbve.sh` (preferred — handles env setup automatically):
   ```bash
   ./kbve.sh -worktree <task-name>
   ```
   This creates the worktree, generates `.env.local` with correct Nx isolation, copies `.env`, and runs `pnpm install`.

   Manual alternative:
   ```bash
   git fetch origin dev
   git worktree add ../kbve-<task-name> dev -b trunk/<task-name>-<MM-DD-YYYY>
   ```

2. **Nx environment** (auto-generated by `kbve.sh -worktree`, or create manually):
   ```bash
   # .env.local in the worktree root
   NX_WORKSPACE_ROOT=/absolute/path/to/worktree
   NX_WORKSPACE_ROOT_PATH=/absolute/path/to/worktree
   NX_WORKSPACE_DATA_DIRECTORY=.nx/workspace-data-<worktree-basename>
   NX_CACHE_DIRECTORY=.nx/cache
   NX_DAEMON=false
   ```
   `NX_WORKSPACE_ROOT_PATH` is critical — Nx resolves the workspace root at module-load time (before dotenv), so it must be a real shell env var. Use `./kbve.sh -nx` (which auto-sources `.env.local`) or manually `export NX_WORKSPACE_ROOT_PATH=$PWD` after entering the worktree.
   `NX_WORKSPACE_DATA_DIRECTORY` gives each worktree its own project-graph/daemon cache, preventing cross-worktree crosstalk.
   `NX_CACHE_DIRECTORY` isolates the task cache per worktree so cached outputs don't collide across checkouts.

3. **Install dependencies** (skipped if `kbve.sh -worktree` was used):
   ```bash
   cd ../kbve-<task-name> && pnpm install
   ```

4. **Do work** — make changes, test, iterate.

5. **Commit** using conventional commits (`feat`, `fix`, `refactor`, `chore`, etc.):
   ```bash
   git add <files>
   git commit -m "feat(scope): short description"
   ```

6. **Push and PR to `dev`**:
   ```bash
   git push -u origin trunk/<task-name>-<MM-DD-YYYY>
   gh pr create --base dev --title "feat(scope): short description" --body "..."
   ```

7. **After merge**, clean up:
   ```bash
   ./kbve.sh -worktree-rm <task-name>
   ```
   Or manually:
   ```bash
   git worktree remove ../kbve-<task-name>
   git branch -d trunk/<task-name>-<MM-DD-YYYY>
   ```

## Rules

- Branch naming: `trunk/<task-name>-<MM-DD-YYYY>`
- Worktree path: `../kbve-<task-name>` (adjacent to main repo)
- Always `pnpm install` in new worktrees
- Always create `.env.local` with `NX_WORKSPACE_ROOT`, `NX_WORKSPACE_DATA_DIRECTORY`, `NX_CACHE_DIRECTORY`, and `NX_DAEMON=false` — or use `./kbve.sh -worktree` which handles this automatically
- **Always use `./kbve.sh -nx` instead of bare `pnpm nx` in worktrees** — it sources `.env.local` before running Nx, ensuring daemon/cache isolation is applied. Running `pnpm nx` directly skips `.env.local` and can cause stale graph or cache collisions
- PRs target `dev`, never `main`
- No co-authoring lines in commits
- Keep PR descriptions concise

---

<!-- nx configuration start-->
<!-- Leave the start & end comments to automatically receive updates. -->

# General Guidelines for working with Nx

- For navigating/exploring the workspace, invoke the `nx-workspace` skill first - it has patterns for querying projects, targets, and dependencies
- When running tasks (for example build, lint, test, e2e, etc.), always prefer running the task through `nx` (i.e. `nx run`, `nx run-many`, `nx affected`) instead of using the underlying tooling directly
- Prefix nx commands with the workspace's package manager (e.g., `pnpm nx build`, `npm exec nx test`) - avoids using globally installed CLI
- You have access to the Nx MCP server and its tools, use them to help the user
- For Nx plugin best practices, check `node_modules/@nx/<plugin>/PLUGIN.md`. Not all plugins have this file - proceed without it if unavailable.
- NEVER guess CLI flags - always check nx_docs or `--help` first when unsure

## Scaffolding & Generators

- For scaffolding tasks (creating apps, libs, project structure, setup), ALWAYS invoke the `nx-generate` skill FIRST before exploring or calling MCP tools

## When to use nx_docs

- USE for: advanced config options, unfamiliar flags, migration guides, plugin configuration, edge cases
- DON'T USE for: basic generator syntax (`nx g @nx/react:app`), standard commands, things you already know
- The `nx-generate` skill handles generator discovery internally - don't call nx_docs just to look up generator syntax

<!-- nx configuration end-->
